## ãƒ­ãƒ¼ã‚°ãƒ©ã‚¤ã‚¯ã‚²ãƒ¼ãƒ ã‚’ä½œã£ã¦ã¿ã‚‹ãã®7 æ•µã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã¨æº€è…¹åº¦

### éå»è¨˜äº‹ä¸€è¦§

* [ãã®1 ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢](https://qiita.com/pizyumi/items/3526fddd4f18a462e1ae)
* [ãã®2 ãƒ€ãƒ³ã‚¸ãƒ§ãƒ³ãƒ»ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ç”Ÿæˆã¨æç”»](https://qiita.com/pizyumi/items/2562a159f497a608615b)
* [ãã®3 ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ç§»å‹•](https://qiita.com/pizyumi/items/07447c9a1a52b0d9a228)
* [ãã®4 ãƒ€ãƒ³ã‚¸ãƒ§ãƒ³ã®ãƒ©ãƒ³ãƒ€ãƒ ç”Ÿæˆ]()
* [ãã®5 ãƒ€ãƒ³ã‚¸ãƒ§ãƒ³ã®ã‚µã‚¤ã‚º]()

ç¾åœ¨ã®ã‚³ãƒ¼ãƒ‰ã«ã¤ã„ã¦ã¯å‰å›ã®è¨˜äº‹ã®æœ€å¾Œã®é …ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

### ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹

ä»Šå›ã¯é‚ã«æ•µã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’ç”Ÿæˆã—ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ãŒã€æ•µã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãŒç”Ÿæˆã•ã‚Œã‚Œã°æ•µã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã¨ã®æˆ¦é—˜ã‚‚ã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã„ã‹ãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ã€‚

æ•µã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã¨ã®æˆ¦é—˜ã‚’å®Ÿç¾ã™ã‚‹ã«ã¯ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã¨ã—ã¦æœ€ä½ã§ã‚‚

* HP

ã‚’è¿½åŠ ã—ãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ã€‚æ•µã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¸ã®æ”»æ’ƒã«ã‚ˆã£ã¦ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®HPãŒã¯æ¸›å°‘ã—ã€ã‚‚ã—ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®HPãŒ0ï¼ˆä»¥ä¸‹ï¼‰ã«ãªã£ã¦ã—ã¾ã†ã¨ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ã§ã™ã€‚

åŒæ§˜ã«ã€æ•µã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚‚HPã‚’æœ‰ã—ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ•µã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã¸ã®æ”»æ’ƒãªã©ã«ã‚ˆã£ã¦æ•µã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®HPã‚’0ï¼ˆä»¥ä¸‹ï¼‰ã«ã™ã‚‹ã“ã¨ãŒã§ãã‚Œã°æ•µã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã¯æ­»äº¡ã—ã¾ã™ã€‚

æ”»æ’ƒã«ã‚ˆã£ã¦æ¸›å°‘ã™ã‚‹HPã®é‡ã‚’ãƒ€ãƒ¡ãƒ¼ã‚¸ã¨è¨€ã„ã¾ã™ãŒã€æ”»æ’ƒã®éš›ã«æ¯å›å¿…ãšåŒã˜ãƒ€ãƒ¡ãƒ¼ã‚¸ãŒç™ºç”Ÿã™ã‚‹ã®ã§ã¯é¢ç™½ã¿ã«æ¬ ã‘ã¾ã™ã€‚

ãã“ã§ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’è¨ˆç®—ã™ã‚‹ãŸã‚ã«ä¸‹ã®ã‚ˆã†ãªã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’è¿½åŠ ã—ã¾ã™ã€‚

* æ”»æ’ƒåŠ›
* é˜²å¾¡åŠ›

æ”»æ’ƒåŠ›ã¯æ”»æ’ƒã®å¼·ã•ã§ã‚ã‚Šã€æ”»æ’ƒåŠ›ãŒé«˜ã‘ã‚Œã°é«˜ã„ã»ã©æ•µã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã«ã‚ˆã‚Šå¤šãã®ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’ä¸ãˆã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ã¾ãŸã€é˜²å¾¡åŠ›ã¯æ”»æ’ƒã‚’é˜²ãå¼·ã•ã§ã‚ã‚Šã€é˜²å¾¡åŠ›ãŒé«˜ã‘ã‚Œã°é«˜ã„ã»ã©æ•µã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‹ã‚‰ã‚ˆã‚Šå°‘ãªã„ãƒ€ãƒ¡ãƒ¼ã‚¸ã—ã‹å—ã‘ãªã„ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

æ›´ã«ã€HPã‚„æ”»æ’ƒåŠ›ã‚„é˜²å¾¡åŠ›ã¯æ•µã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã¨ã®æˆ¦é—˜ã«å‹åˆ©ã™ã‚‹ã«ã¤ã‚Œã¦å€¤ã‚’å¢—ã‚„ã—ã¦ã„ããŸã„ã§ã™ã€‚

ã“ã‚Œã«ã‚ˆã‚Šã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æˆé•·ã‚’è¡¨ç¾ã—ã¾ã™ã€‚

ã“ã‚Œã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã«ä¸‹ã®ã‚ˆã†ãªã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’è¿½åŠ ã—ã¾ã™ã€‚

* çµŒé¨“å€¤
* ãƒ¬ãƒ™ãƒ«

çµŒé¨“å€¤ã¯æ•µã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’å€’ã™ã“ã¨ãªã©ã«ã‚ˆã£ã¦å¾—ã‚‰ã‚Œã‚‹ã“ã¨ã«ã—ã¾ã™ã€‚

ãã—ã¦ã€çµŒé¨“å€¤ãŒä½•ã‚‰ã‹ã®å€¤ã‚’è¶…ãˆã‚‹ã¨ãƒ¬ãƒ™ãƒ«ãŒä¸Šæ˜‡ã—ã¾ã™ã€‚ãƒ¬ãƒ™ãƒ«ãŒä¸Šæ˜‡ã™ã‚‹ã¨HPã‚„æ”»æ’ƒåŠ›ã‚„é˜²å¾¡åŠ›ã‚‚ä¸€ç·’ã«ä¸Šæ˜‡ã—ã¾ã™ã€‚

ã“ã‚Œã‚‰ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã«ã‚ˆã‚Šã€æ•µã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã¨ã®æˆ¦é—˜ã‚„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æˆé•·ã¨ã„ã†ã‚²ãƒ¼ãƒ ã‚‰ã—ã„è¦ç´ ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚

ã¨ã„ã†è¨³ã§ã€ã“ã‚Œã‚‰ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’è¿½åŠ ã—ã¾ã™ã€‚

ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã¯`player`å¤‰æ•°ã§ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨ã—ã¦ç®¡ç†ã—ã¦ã„ã‚‹ã®ã§ã—ãŸã€‚

ã“ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ä¸Šã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’è¿½åŠ ã™ã‚Œã°è‰¯ã„ã®ã§ã™ãŒã€ã“ã‚Œã‚’æ©Ÿã«ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç®¡ç†ã‚’ã‚¯ãƒ©ã‚¹åŒ–ã—ã¾ã—ã‚‡ã†ã€‚

ä¸‹ã®ã‚ˆã†ãª`Player`ã‚¯ãƒ©ã‚¹ã‚’ä½œæˆã—ã¾ã™ã€‚

`depth`ã€`x`ã€`y`ã¯ä»Šã¾ã§ã¨åŒã˜ã§ã™ã€‚

`level`ã¯ãƒ¬ãƒ™ãƒ«ã‚’è¡¨ã—ã€åˆæœŸå€¤ã¯`1`ã¨ã—ã¾ã™ã€‚

`hpbase`ã¯ãƒ™ãƒ¼ã‚¹ã®æœ€å¤§HPã‚’è¡¨ã—ã€åˆæœŸå€¤ã¯`16`ã¨ã—ã¾ã™ã€‚ãƒ™ãƒ¼ã‚¹ã®æœ€å¤§HPã¯ãƒ¬ãƒ™ãƒ«ã®ä¸Šæ˜‡ã«ã‚ˆã£ã¦ä¸Šæ˜‡ã—ã¾ã™ã€‚`hpext`ã¯ä»˜åŠ çš„ãªæœ€å¤§HPã‚’è¡¨ã™ã“ã¨ã«ã—ã¾ã™ã€‚å®Ÿéš›ã®æœ€å¤§HPã¯ãƒ™ãƒ¼ã‚¹ã®æœ€å¤§HPã¨ä»˜åŠ çš„ãªæœ€å¤§HPã‚’è¶³ã—åˆã‚ã›ãŸã‚‚ã®ã¨ãªã‚Šã€`hpfull`ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã§å¾—ã‚‰ã‚Œã‚‹ã‚ˆã†ã«ã—ã¾ã—ãŸã€‚

`atkbase`ã¯ãƒ™ãƒ¼ã‚¹ã®æ”»æ’ƒåŠ›ã‚’è¡¨ã—ã€`atkext`ã¯ä»˜åŠ çš„ãªæ”»æ’ƒåŠ›ã‚’è¡¨ã—ã€`defbase`ã¯ãƒ™ãƒ¼ã‚¹ã®é˜²å¾¡åŠ›ã‚’è¡¨ã—ã€`defext`ã¯ä»˜åŠ çš„ãªé˜²å¾¡åŠ›ã‚’è¡¨ã—ã¾ã™ã€‚

`expfull`ã¯æ¬¡ã«ãƒ¬ãƒ™ãƒ«ãŒä¸Šæ˜‡ã™ã‚‹ã®ã«å¿…è¦ãªçµŒé¨“å€¤ã®é‡ã‚’è¡¨ã™ã‚‚ã®ã¨ã—ã¾ã™ã€‚

`hp`ã¯ç¾åœ¨ã®HPã‚’è¡¨ã—ã€`exp`ã¯ç¾åœ¨ã®çµŒé¨“å€¤ã‚’è¡¨ã™ã“ã¨ã«ã—ã¾ã™ã€‚

```js
class Player {
	constructor () {
		this.depth = 0;
		this.x = 12;
		this.y = 17;

		this.level = 1;
		this.hpbase = 16;
		this.hpext = 0;
		this.atkbase = 4;
		this.atkext = 0;
		this.defbase = 4;
		this.defext = 0;
		this.expfull = 4;

		this.hp = this.hpfull;
		this.exp = 0;
	}

	get hpfull () {
		return this.hpbase + this.hpext;
	}

	get atk () {
		return this.atkbase + this.atkext;
	}

	get def () {
		return this.defbase + this.defext;
	}
}
```

`init`é–¢æ•°ã§`player`å¤‰æ•°ã«`Player`ã‚¯ãƒ©ã‚¹ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’æ ¼ç´ã™ã‚‹ã‚ˆã†å¤‰æ›´ã—ã¾ã™ã€‚

```js
function init () {
	fields = [];
	fields[0] = create_field(0, [], seed);
	player = new Player();
	messages = [{
		text: MSG_INIT,
		type: 'special'
	}];
}
```

### ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®æç”»

è¿½åŠ ã•ã‚ŒãŸãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ã‚²ãƒ¼ãƒ ç”»é¢ã«æç”»ã—ã¾ã™ã€‚

ã‚²ãƒ¼ãƒ ç”»é¢ã«æç”»ã™ã‚‹ãƒ†ã‚­ã‚¹ãƒˆã‚’ä¿æŒã™ã‚‹å¤‰æ•°ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```js
var TEXT_LEVEL = 'ãƒ¬ãƒ™ãƒ«';
var TEXT_HP = 'HP';
var TEXT_ATK = 'æ”»æ’ƒåŠ›';
var TEXT_DEF = 'é˜²å¾¡åŠ›';
var TEXT_EXP = 'çµŒé¨“å€¤';
```

`draw`é–¢æ•°ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æç”»å‡¦ç†ã‚’ä¸‹ã®ã‚ˆã†ã«å¤‰æ›´ã—ã¾ã™ã€‚

```js
	con.save();
	con.textBaseline = 'top';
	con.textAlign = 'left';
	con.font = '24px consolas';
	con.fillStyle = 'white';
	con.translate(SX * PX, 0);
	con.fillText(player.depth + 'F', 8, (24 + 6) * 0 + 8);
	con.fillText(TEXT_LEVEL + 'ï¼š' + player.level, 8, (24 + 6) * 1 + 8);
	con.fillText(TEXT_HP + 'ï¼š' + player.hp + '/' + player.hpfull, 8, (24 + 6) * 2 + 8);
	con.fillText(TEXT_ATK + 'ï¼š' + player.atk, 8, (24 + 6) * 3 + 8);
	con.fillText(TEXT_DEF + 'ï¼š' + player.def, 8, (24 + 6) * 4 + 8);
	con.fillText(TEXT_EXP + 'ï¼š' + player.exp + '/' + player.expfull, 8, (24 + 6) * 5 + 8);
	con.restore();
}
```

### æ•µã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®ç”Ÿæˆ

æ•µã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’ç”Ÿæˆã—ã¾ã™ã€‚

ä»Šå›ã¯ã€Œãƒ©ãƒƒãƒˆã€ã¨ã„ã†æ•µã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’ç”Ÿæˆã™ã‚‹ã“ã¨ã«ã—ã¾ã™ã€‚

ã¾ãšãƒ©ãƒƒãƒˆã®å®šç¾©ã‚’è¡Œã„ã¾ã™ã€‚

æ•µã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®æƒ…å ±ã¯`E_INFO`ã¨ã„ã†é…åˆ—ã«å®šç¾©ã™ã‚‹ã“ã¨ã«ã—ã¾ã™ã€‚

æ•µã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã¯ãƒ¬ãƒ™ãƒ«ã‚„HPã‚„æ”»æ’ƒåŠ›ã‚„é˜²å¾¡åŠ›ã‚„çµŒé¨“å€¤ã‚’æŒã¡ã¾ã™ã€‚

æ•µã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã¯ï¼ˆå°‘ãªãã¨ã‚‚ä»Šã®ã¨ã“ã‚ï¼‰çµŒé¨“å€¤ã‚’å¾—ã‚‹ã¨ã„ã†ã“ã¨ã¯ã‚ã‚Šã¾ã›ã‚“ã®ã§ã€æ•µã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®çµŒé¨“å€¤ã¨ã¯ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒæ•µã‚’å€’ã™ã“ã¨ã«ã‚ˆã£ã¦å¾—ã‚‰ã‚Œã‚‹çµŒé¨“å€¤ã‚’è¡¨ã—ã¾ã™ã€‚

ã“ã®å®šç¾©ã¯ãƒ¬ãƒ™ãƒ«1ã®ãƒ©ãƒƒãƒˆã®å®šç¾©ã§ã™ã€‚ãƒ¬ãƒ™ãƒ«2ä»¥ä¸Šã®ãƒ©ãƒƒãƒˆã®æƒ…å ±ã¯ãƒ¬ãƒ™ãƒ«1ã®ãƒ©ãƒƒãƒˆã®æƒ…å ±ã‹ã‚‰è¨ˆç®—ã™ã‚‹ã“ã¨ã«ã—ã¾ã™ã€‚

```js
var E_RAT_NAME = 'ãƒ©ãƒƒãƒˆ';
```

```
var E_RAT = 0;

var E_INFO = [];
E_INFO[E_RAT] = {
	dname: E_RAT_NAME,
	level: 1,
	hp: 4,
	atk: 3,
	def: 3,
	exp: 1
};
```

æ•µã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’è¡¨ã™ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯`Enemy`ã‚¯ãƒ©ã‚¹ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¨ã—ã¾ã™ã€‚

ä¸‹ã®ã‚ˆã†ãª`Enemy`ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ ã—ã¾ã™ã€‚

`Enemy`ã‚¯ãƒ©ã‚¹ã®ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã¯æ•µã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®ç¨®é¡ã¨ä½ç½®ã¨ãƒ¬ãƒ™ãƒ«ã‚’å¼•æ•°ã¨ã—ã¦å–ã‚Šã¾ã™ã€‚

æ•µã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã¯æ•µã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®ç¨®é¡ã¨ãƒ¬ãƒ™ãƒ«ã«ã‚ˆã£ã¦æ±ºã¾ã‚Šã¾ã™ã€‚

```js
class Enemy {
	constructor (type, x, y, level) {
		var e = E_INFO[type];

		this.type = type;
		this.x = x;
		this.y = y;

		this.dname = e.dname;

		this.level = e.level;
		this.hpbase = e.hp;
		this.hpext = 0;
		this.atkbase = e.atk;
		this.atkext = 0;
		this.defbase = e.def;
		this.defext = 0;
		this.exp = e.exp;

		while (level > this.level) {
			this.level++;
			this.hpbase = Math.ceil(this.hpbase * 1.2);
			this.atkbase = Math.ceil(this.atkbase * 1.1);
			this.defbase = Math.ceil(this.defbase * 1.1);
			this.exp = Math.ceil(this.exp * 1.4);
		}

		this.hp = this.hpfull;
		this.atk = this.atkfull;
		this.def = this.deffull;
	}

	get hpfull () {
		return this.hpbase + this.hpext;
	}

	get atkfull () {
		return this.atkbase + this.atkext;
	}

	get deffull () {
		return this.defbase + this.defext;
	}
}
```

æ•µã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã¯ãƒ•ãƒ­ã‚¢ã®éƒ¨å±‹ã®ãƒ©ãƒ³ãƒ€ãƒ ãªä½ç½®ã«ç”Ÿæˆã™ã‚‹ã“ã¨ã«ã—ã¾ã™ã€‚

`create_field`é–¢æ•°ã‚’ä¸‹ã®ã‚ˆã†ã«å¤‰æ›´ã—ã¾ã™ã€‚

`create_field`é–¢æ•°ã¯ãƒ•ãƒ­ã‚¢ã§ç”Ÿæˆã•ã‚ŒãŸæ•µã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’è¡¨ã™ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®é…åˆ—ã‚’ãƒ•ãƒ­ã‚¢ã‚’è¡¨ã™ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®`npcs`ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã§è¿”ã™ã“ã¨ã«ã—ã¾ã™ã€‚

0éšã«ã¯æ•µã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’é…ç½®ã—ãªã„ãŸã‚ã€`npcs`ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®å€¤ã¯ç©ºã®é…åˆ—ã¨ãªã‚Šã¾ã™ã€‚

ãã‚Œä»¥å¤–ã®éšã«ã¯éƒ¨å±‹ã”ã¨ã«æœ€å¤§2ä½“ã®ãƒ©ãƒƒãƒˆã‚’ãƒ©ãƒ³ãƒ€ãƒ ãªä½ç½®ã«ç”Ÿæˆã—ã¾ã™ã€‚

ã¾ãŸã€ãƒ©ãƒƒãƒˆã®ãƒ¬ãƒ™ãƒ«ã‚‚ãƒ•ãƒ­ã‚¢ã®éšæ•°ã«å¿œã˜ã¦ã‚ã‚‹ç¨‹åº¦ãƒ©ãƒ³ãƒ€ãƒ ã«æ±ºå®šã—ã¾ã™ã€‚

```js
function create_field (depth, upstairs, base_seed) {
ï¼ˆçœç•¥ï¼‰
	if (depth === 0) {
ï¼ˆçœç•¥ï¼‰
		return {
			nx: nx,
			ny: ny,
			blocks: blocks,
			npcs: []
		};
	}
ï¼ˆçœç•¥ï¼‰
	var npcs = [];
	for (var i = 0; i < ers.length; i++) {
		var num = random.num(3);
		for (var j = 0; j < num; j++) {
			var x = random.num(ers[i].x2 - ers[i].x1) + ers[i].x1;
			var y = random.num(ers[i].y2 - ers[i].y1) + ers[i].y1;
			var type = E_RAT;
			var level = depth + random.num(depth) + random.num(2);

			npcs.push(new Enemy(type, x, y, level));
		}
	}
ï¼ˆçœç•¥ï¼‰
	return {
		nx: nx,
		ny: ny,
		blocks: blocks,
		npcs: npcs
	};
}
```

### æ•µã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®æç”»

æ•µã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®æç”»ã‚’è¡Œã„ã¾ã™ã€‚

`draw`é–¢æ•°ã«ä¸‹ã®ã‚ˆã†ãªã‚³ãƒ¼ãƒ‰ã‚’è¿½åŠ ã—ã¾ã™ã€‚

ãƒ©ãƒƒãƒˆãŒã„ã‚‹ä½ç½®ã«ãƒã‚ºãƒŸã®çµµæ–‡å­—ã‚’æç”»ã—ã¾ã™ã€‚

```js
	con.textBaseline = 'middle';
	con.textAlign = 'center';
	var npcs = fields[player.depth].npcs;
	for (var i = 0; i < npcs.length; i++) {
		if (npcs[i].x >= ox && npcs[i].x < ox + SX && npcs[i].y >= oy && npcs[i].y < oy + SY) {
			if (npcs[i].type === E_RAT) {
				con.fillStyle = 'yellow';
				con.font = '16px consolas';
				con.fillText('ğŸ€\uFE0E', (npcs[i].x - ox) * PX + (PX / 2), (npcs[i].y - oy) * PY + (PY / 2));
			}
		}
	}
```

### ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ”»æ’ƒ

ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒæ•µã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’æ”»æ’ƒã™ã‚‹å ´åˆã®å‡¦ç†ã‚’è¿½åŠ ã—ã¾ã™ã€‚

ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯çŸ¢å°ã‚­ãƒ¼ã‚’ä½¿ã£ã¦æ•µã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’æ”»æ’ƒã™ã‚‹ã“ã¨ã«ã—ã¾ã™ã€‚

ã“ã‚Œã¾ã§ã¯çŸ¢å°ã‚­ãƒ¼ã®æ“ä½œã«ã‚ˆã‚Šãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ç§»å‹•ã™ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸãŒã€ç§»å‹•å…ˆã«æ•µã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãŒã„ã‚‹å ´åˆã«ã¯ç§»å‹•ã‚’è¡Œã†ä»£ã‚ã‚Šã«ãã®æ•µã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’æ”»æ’ƒã™ã‚‹ã“ã¨ã«ã—ã¾ã™ã€‚

ã¾ãšå¿…è¦ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’å®šç¾©ã—ã¾ã™ã€‚

ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ãƒ†ã‚­ã‚¹ãƒˆã«å€¤ã‚’åŸ‹ã‚è¾¼ã‚€å¿…è¦ãŒã‚ã‚‹å ´åˆã«ã¯æ–‡å­—åˆ—ãã®ã‚‚ã®ã§ã¯ãªãã€æ–‡å­—åˆ—ã‚’è¿”ã™é–¢æ•°ã¨ã—ã¦å®šç¾©ã™ã‚‹ã“ã¨ã«ã—ã¾ã™ã€‚æ–‡å­—åˆ—ã‚’è¿”ã™é–¢æ•°ã¯åŸ‹ã‚è¾¼ã‚€å€¤ã‚’è¾æ›¸ã¨ã—ã¦å—ã‘å–ã‚‹ã‚ˆã†ã«ã™ã‚‹ã¨ä¾¿åˆ©ã§ã—ã‚‡ã†ã€‚

```js
var MSG_PATTACK = ({name, dam}) => `${name}ã«${dam}ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’ä¸ãˆã¾ã—ãŸã€‚`;
var MSG_KILL = ({name, exp}) => `${name}ã‚’å€’ã—ã¾ã—ãŸã€‚${exp}ã®çµŒé¨“å€¤ã‚’å¾—ã¾ã—ãŸã€‚`;
var MSG_LEVELUP = ({level}) => `ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ã€‚ã‚ãªãŸã¯ãƒ¬ãƒ™ãƒ«${level}ã«ãªã‚Šã¾ã—ãŸã€‚`
```

ãã—ã¦ã€2ã¤ç›®ã®`keydown`ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ã‚’ä¸‹ã®ã‚ˆã†ã«å¤‰æ›´ã—ã¾ã™ã€‚

ç§»å‹•ã—ã‚ˆã†ã¨ã—ãŸæ–¹å‘ã«æ•µã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãŒã„ã‚‹å ´åˆã«ã¯ãƒ€ãƒ¡ãƒ¼ã‚¸ã®è¨ˆç®—ã‚’è¡Œã„ã€æ•µã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®HPã‚’ãƒ€ãƒ¡ãƒ¼ã‚¸åˆ†æ¸›ã‚‰ã—ã¾ã™ã€‚

æ•µã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®HPãŒ0ä»¥ä¸‹ã«ãªã£ãŸå ´åˆã«ã¯ãƒ•ãƒ­ã‚¢ã‹ã‚‰ãã®æ•µã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’å‰Šé™¤ã—ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®çµŒé¨“å€¤ã«æ•µã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®çµŒé¨“å€¤ã‚’åŠ ç®—ã—ã¾ã™ã€‚

ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®çµŒé¨“å€¤ãŒãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ã™ã‚‹çµŒé¨“å€¤ã‚’è¶…ãˆãŸå ´åˆã«ã¯ãƒ¬ãƒ™ãƒ«ã‚’1ä¸Šã’ã€HPã‚„æ”»æ’ƒåŠ›ã‚„é˜²å¾¡åŠ›ã‚‚å¢—ã‚„ã—ã¾ã™ã€‚ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ã«å¿…è¦ãªçµŒé¨“å€¤ã‚‚æ›´æ–°ã—ã¾ã™ã€‚

```js
	c.on('keydown', function (e) {
ï¼ˆçœç•¥ï¼‰
		if (e.keyCode >= 37 && e.keyCode <= 40) {
ï¼ˆçœç•¥ï¼‰
			if (x !== player.x || y !== player.y) {
				var npcs = fields[player.depth].npcs;
				var c = undefined;
				var index = 0;
				for (var i = 0; i < npcs.length; i++) {
					if (npcs[i].x === x && npcs[i].y === y) {
						c = npcs[i];
						index = i;
						break;
					}
				}
				if (c) {
					var dam = calculate_damage(player.atk, c.def);
					c.hp -= dam;
					add_message({
						text: MSG_PATTACK({name: c.dname, dam}),
						type: 'pattack'
					});
					if (c.hp <= 0) {
						npcs.splice(index, 1);
						player.exp += c.exp;
						add_message({
							text: MSG_KILL({name: c.dname, exp: c.exp}),
							type: 'important'
						});

						while (player.exp >= player.expfull) {
							player.level++;
							player.hpbase = Math.ceil(player.hpbase * 1.2);
							player.atkbase = Math.ceil(player.atkbase * 1.1);
							player.defbase = Math.ceil(player.defbase * 1.1);
							player.expfull = Math.ceil(player.expfull * 2.4);
							add_message({
								text: MSG_LEVELUP({level: player.level}),
								type: 'important'
							});
						}
					}
				}
				else {
					var block = fields[player.depth].blocks[x][y];
					if (B_CAN_STAND[block.base]) {
						player.x = x;
						player.y = y;
					}
					else {
						if (block.base === B_WALL) {
							add_message({
								text: MSG_WALL,
								type: 'normal'
							});

							draw(con, env);
						}

						return;
					}
				}
			}
			else {
				return;
			}
		}
		else if (e.keyCode === 32) {
ï¼ˆçœç•¥ï¼‰
		}
		else {
			return;
		}

		draw(con, env);
	});
```

æ”»æ’ƒåŠ›ã¨é˜²å¾¡åŠ›ã‹ã‚‰ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’è¨ˆç®—ã™ã‚‹`calculate_damage`é–¢æ•°ã¯ä¸‹ã®ã‚ˆã†ã«ã—ã¾ã™ã€‚

æ”»æ’ƒåŠ›ã‚’è£œæ­£ã—ãŸã‚‚ã®ã¨é˜²å¾¡åŠ›ã‚’è£œæ­£ã—ãŸã‚‚ã®ã®å·®ã‚’å–ã‚Šã€ãƒ©ãƒ³ãƒ€ãƒ ãªå€¤ã‚’æ›ã‘ã¦ãƒ©ãƒ³ãƒ€ãƒ ãªãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’è¨ˆç®—ã—ã¾ã™ã€‚

ãƒ€ãƒ¡ãƒ¼ã‚¸ãŒ0ä»¥ä¸‹ã§ã‚ã‚‹å ´åˆã«ã¯1ã¨ã—ã¾ã™ã€‚

```js
function calculate_damage (atk, def) {
	var dam = Math.ceil((atk * 1.1 - def * 0.4) * Math.random());
	if (dam <= 0) {
		dam = 1;
	}
	return dam;
}
```

`draw`é–¢æ•°ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æç”»å‡¦ç†ã‚’ä¸‹ã®ã‚ˆã†ã«å¤‰æ›´ã—ã¾ã™ã€‚

ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ç¨®é¡ãŒ`important`ã§ã‚ã‚‹å ´åˆã¨`pattack`ã§ã‚ã‚‹å ´åˆã®å‡¦ç†ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```js
	con.save();
	con.textBaseline = 'top';
	con.textAlign = 'left';
	con.font = '16px consolas';
	con.translate(SX * PX, SCREEN_Y - ((16 + 6) * NUM_MESSAGE + 8 * 2));
	for (var i = 0; i < messages.length; i++) {
		if (messages[i].type === 'normal') {
			con.fillStyle = 'white';
		}
		else if (messages[i].type === 'special') {
			con.fillStyle = 'yellow';
		}
		else if (messages[i].type === 'important') {
			con.fillStyle = 'red';
		}
		else if (messages[i].type === 'pattack') {
			con.fillStyle = 'yellowgreen';
		}
		else {
			throw new Error('not supported.');
		}
		var text = messages[i].text;
		if (messages[i].repeat) {
			text += 'ï¼ˆ' + 'x' + messages[i].repeat + 'ï¼‰';
		}
		con.fillText(text, 8, (16 + 6) * i + 8);
	}
	con.restore();
```

### æ•µã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®æ”»æ’ƒã¨ç§»å‹•

æ•µã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãŒãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’æ”»æ’ƒã™ã‚‹å ´åˆã®å‡¦ç†ã‚’è¿½åŠ ã—ã¾ã™ã€‚

ãƒ­ãƒ¼ã‚°ãƒ©ã‚¤ã‚¯ã‚²ãƒ¼ãƒ ã¯ã‚¿ãƒ¼ãƒ³åˆ¶ã®ã‚²ãƒ¼ãƒ ã§ã™ã€‚

ã¤ã¾ã‚Šã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒä½•ã‚‰ã‹ã®è¡Œå‹•ã‚’ã™ã‚‹ã¨æ¬¡ã¯æ•µã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®ã‚¿ãƒ¼ãƒ³ã¨ãªã‚Šã€æ•µãŒè¡Œå‹•ã—ã¾ã™ã€‚

æ•µã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã¯ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒè¡Œå‹•ã™ã‚‹ã¾ã§å‹•ã‹ãšå¾…ã£ã¦ãã‚Œã‚‹ã®ã§ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯æœ€å–„ã®è¡Œå‹•ã‚’é¸æŠã™ã‚‹ãŸã‚ã«å¹¾ã‚‰ã§ã‚‚è€ƒãˆã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

å‹¿è«–ã€ç´ æ—©ã•ã®ã‚ˆã†ãªæ¦‚å¿µã‚’å°å…¥ã—ã¦ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒ1å›è¡Œå‹•ã™ã‚‹ã”ã¨ã«æ•µã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãŒè¤‡æ•°å›è¡Œå‹•ã—ãŸã‚Šã€é€†ã«æ•µã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãŒ1å›è¡Œå‹•ã™ã‚‹ã”ã¨ã«ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒè¤‡æ•°å›è¡Œå‹•ã™ã‚‹ã‚ˆã†ã«ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ãŒã€ã¨ã‚Šã‚ãˆãšã“ã®ã‚²ãƒ¼ãƒ ã§ã¯ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒ1å›è¡Œå‹•ã—ãŸã‚‰åŒã˜ãƒ•ãƒ­ã‚¢å†…ã«ã„ã‚‹å…¨ã¦ã®æ•µã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãŒãã‚Œãã‚Œ1å›è¡Œå‹•ã™ã‚‹ã“ã¨ã«ã—ã¾ã™ã€‚

ã“ã‚Œã‚’å®Ÿç¾ã™ã‚‹ã«ã¯2ã¤ç›®ã®`keydown`ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ã®ã‚­ãƒ¼æ“ä½œå‡¦ç†ã®å¾Œã«æ•µã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®è¡Œå‹•å‡¦ç†ã‚’è¿½åŠ ã—ã¾ã™ã€‚

ãã®å‰ã«ã¾ãšå¿…è¦ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’å®šç¾©ã—ã¾ã™ã€‚

```js
var MSG_EATTACK = ({name, dam}) => `${name}ã‹ã‚‰${dam}ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’å—ã‘ã¾ã—ãŸã€‚`;
var MSG_DIE = 'ã‚ãªãŸã¯å€’ã‚Œã¾ã—ãŸã€‚';
```

ã¾ãŸã€æ•µã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãŒãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’æ”»æ’ƒã—ãŸå ´åˆã«ã¯ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒæ­»ã¬ï¼ˆãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®HPãŒ0ä»¥ä¸‹ã«ãªã‚‹ï¼‰å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒæ­»ã‚“ã å ´åˆã¯ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ã§ã™ã€‚

ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ã«ãªã£ãŸå ´åˆã«ã¯ãã‚Œä»¥ä¸Šã‚²ãƒ¼ãƒ ã‚’ç¶šè¡Œã™ã‚‹ã“ã¨ãŒã§ãã¾ã›ã‚“ã€‚

ã¤ã¾ã‚Šã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’æ“ä½œã™ã‚‹ã“ã¨ã¯ã§ããªããªã‚Šã¾ã™ã€‚

ã¾ãŸã€ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ã«æˆ»ã£ã¦æ–°ã—ã„ã‚²ãƒ¼ãƒ ã‚’å§‹ã‚ã‚‰ã‚Œã‚‹ã‚ˆã†ã«ã—ãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ã€‚

ãã“ã§ã€ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ã«ãªã£ãŸã‹ã©ã†ã‹ã‚’åˆ¤æ–­ã™ã‚‹ãŸã‚ã«`gameover`å¤‰æ•°ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã«ã—ã¾ã™ã€‚

`gameover`å¤‰æ•°ã®å€¤ãŒ`true`ã§ã‚ã‚‹å ´åˆã«ã¯ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ã«ãªã£ãŸã“ã¨ã‚’ç¤ºã™ã‚‚ã®ã¨ã—ã¾ã™ã€‚ãªã®ã§ã€`gameover`å¤‰æ•°ã®åˆæœŸå€¤ã¯`false`ã§ã™ã€‚

```js
var gameover = false;
```

`init`é–¢æ•°ã§`gameover`å¤‰æ•°ã®å€¤ã‚’åˆæœŸåŒ–ã™ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

```js
function init () {
	gameover = false;

	fields = [];
	fields[0] = create_field(0, [], seed);
	player = new Player();
	messages = [{
		text: MSG_INIT,
		type: 'special'
	}];
}
```

ãã—ã¦ã€2ã¤ç›®ã®`keydown`ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ã‚’ä¸‹ã®ã‚ˆã†ã«å¤‰æ›´ã—ã¾ã™ã€‚

`gameover`å¤‰æ•°ã®å€¤ãŒ`true`ã®å ´åˆã«ã¯ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ“ä½œã‚’å—ã‘ä»˜ã‘ã¾ã›ã‚“ã®ã§ã€å‡¦ç†ã‚’ä¸­æ–­ã—ãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ã€‚`z`ã‚­ãƒ¼ãŒæŠ¼ã•ã‚ŒãŸå ´åˆã«ã¯`startf`å¤‰æ•°ã®å€¤ã‚’`false`ã«å¤‰æ›´ã—ã¦å†æç”»ã‚’è¡Œã„ã¾ã™ã€‚ã™ã‚‹ã¨ã€ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ãŒæç”»ã•ã‚Œã¾ã™ã€‚

ã‚­ãƒ¼å‡¦ç†ã®å¾Œã«æ•µã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®è¡Œå‹•å‡¦ç†ã‚’è¨˜è¿°ã—ã¾ã™ã€‚

æ•µã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®éš£ã«ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒã„ã‚‹ã‹ã‚’åˆ¤å®šã—ã€éš£ã«ã„ã‚‹å ´åˆã«ã¯ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’è¨ˆç®—ã—ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®HPã‹ã‚‰ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’å·®ã—å¼•ãã¾ã™ã€‚

ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®HPãŒ0ä»¥ä¸‹ã«ãªã£ãŸå ´åˆã«ã¯ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ã§ã™ã®ã§`gameover`å¤‰æ•°ã®å€¤ã‚’`true`ã«ã—ã€å‡¦ç†ã‚’ä¸­æ–­ã—ã¾ã™ã€‚

æ•µã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®éš£ã«ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒã„ãªã„å ´åˆã«ã¯æ•µã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã¯50%ã®ç¢ºç‡ã§ãƒ©ãƒ³ãƒ€ãƒ ãªæ–¹å‘ã«ç§»å‹•ã‚’è¡Œã†ã‚‚ã®ã¨ã—ã¾ã™ã€‚ãŸã ã—ã€ç§»å‹•å…ˆã®ãƒã‚¹ã®ç¨®é¡ãŒç§»å‹•ä¸å¯ãªã‚‚ã®ã§ã‚ã£ãŸã‚Šã€ç§»å‹•å…ˆã®ãƒã‚¹ã«åˆ¥ã®æ•µã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãŒã„ãŸã‚Šã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒã„ãŸã‚Šã™ã‚‹å ´åˆã«ã¯ç§»å‹•ã‚’è¡Œã„ã¾ã›ã‚“ï¼ˆã‚‚ã£ã¨ã‚‚ã€ç§»å‹•å…ˆã®ãƒã‚¹ã«ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒã„ã‚‹ã¨ã„ã†ã“ã¨ã¯ã‚ã‚Šå¾—ã¾ã›ã‚“ãŒï¼‰ã€‚

```js
	c.on('keydown', function (e) {
		if (!startf) {
ï¼ˆçœç•¥ï¼‰
		}

		if (gameover) {
			if (e.keyCode === 90) {
				startf = false;

				draw(con, env);
			}

			return;
		}

		if (e.keyCode === 16) {
ï¼ˆçœç•¥ï¼‰
		}

		var npcs = fields[player.depth].npcs;

		if (e.keyCode >= 37 && e.keyCode <= 40) {
ï¼ˆçœç•¥ï¼‰
		}
		else if (e.keyCode === 32) {
ï¼ˆçœç•¥ï¼‰
		}
		else {
			return;
		}

		for (var i = 0; i < npcs.length; i++) {
			var c = npcs[i];

			var l = player.x === c.x - 1 && player.y === c.y;
			var u = player.x === c.x && player.y === c.y - 1;
			var r = player.x === c.x + 1 && player.y === c.y;
			var d = player.x === c.x && player.y === c.y + 1;
			var lu = player.x === c.x - 1 && player.y === c.y - 1;
			var ru = player.x === c.x + 1 && player.y === c.y - 1;
			var ld = player.x === c.x - 1 && player.y === c.y + 1;
			var rd = player.x === c.x + 1 && player.y === c.y + 1;
			if (l || u || r || d || lu || ru || ld || rd) {
				var dam = calculate_damage(c.atk, player.def);
				player.hp -= dam;
				add_message({
					text: MSG_EATTACK({name: c.dname, dam}),
					type: 'eattack'
				});
				if (player.hp <= 0) {
					player.hp = 0;
					gameover = true;
					add_message({
						text: MSG_DIE,
						type: 'special'
					});
					break;
				}
			}
			else {
				var m = Math.random();
				if (m < 0.5) {
					var dir = Math.floor(Math.random() * 8);
					var x = c.x;
					var y = c.y;
					if (dir === 0) {
						x--;
					}
					else if (dir === 1) {
						y--;
					}
					else if (dir === 2) {
						x++;
					}
					else if (dir === 3) {
						y++;
					}
					else if (dir === 4) {
						x--;
						y--;
					}
					else if (dir === 5) {
						x++;
						y--;
					}
					else if (dir === 6) {
						x--;
						y++;
					}
					else if (dir === 7) {
						x++;
						y++;
					}
					var block = fields[player.depth].blocks[x][y];
					var c2 = undefined;
					for (var j = 0; j < npcs.length; j++) {
						if (npcs[j].x === x && npcs[j].y === y) {
							c2 = npcs[j];
							break;
						}
					}
					if (B_CAN_STAND[block.base] && !c2 && (player.x !== x || player.y !== y)) {
						c.x = x;
						c.y = y;
					}
				}
			}
		}

		draw(con, env);
	});
```

æœ€å¾Œã«`draw`é–¢æ•°ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æç”»å‡¦ç†ã‚’ä¸‹ã®ã‚ˆã†ã«å¤‰æ›´ã—ã¾ã™ã€‚

ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ç¨®é¡ãŒ`eattack`ã§ã‚ã‚‹å ´åˆã®å‡¦ç†ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```js
	con.save();
	con.textBaseline = 'top';
	con.textAlign = 'left';
	con.font = '16px consolas';
	con.translate(SX * PX, SCREEN_Y - ((16 + 6) * NUM_MESSAGE + 8 * 2));
	for (var i = 0; i < messages.length; i++) {
		if (messages[i].type === 'normal') {
			con.fillStyle = 'white';
		}
		else if (messages[i].type === 'special') {
			con.fillStyle = 'yellow';
		}
		else if (messages[i].type === 'important') {
			con.fillStyle = 'red';
		}
		else if (messages[i].type === 'pattack') {
			con.fillStyle = 'yellowgreen';
		}
		else if (messages[i].type === 'eattack') {
			con.fillStyle = 'aqua';
		}
		else {
			throw new Error('not supported.');
		}
		var text = messages[i].text;
		if (messages[i].repeat) {
			text += 'ï¼ˆ' + 'x' + messages[i].repeat + 'ï¼‰';
		}
		con.fillText(text, 8, (16 + 6) * i + 8);
	}
	con.restore();
```

### æº€è…¹åº¦

ä»Šå›ã®è¨˜äº‹ã®ã‚‚ã†1ã¤ã®ãƒ†ãƒ¼ãƒã§ã‚ã‚‹æº€è…¹åº¦ã«ã¤ã„ã¦è€ƒãˆã¾ã™ã€‚

æº€è…¹åº¦ã¨ã„ã†ã®ã¯å¹¾ã¤ã‹ã®ãƒ­ãƒ¼ã‚°ãƒ©ã‚¤ã‚¯ã‚²ãƒ¼ãƒ ã§æ¡ç”¨ã•ã‚Œã¦ã„ã‚‹ã‚·ã‚¹ãƒ†ãƒ ã§ã™ã€‚

æº€è…¹åº¦ã¯ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®HPã‚’å¢—æ¸›ã•ã›ã‚‹è¦ç´ ã¨ãªã‚Šã¾ã™ã€‚

æº€è…¹åº¦ãŒ1ä»¥ä¸Šã§ã‚ã‚‹å ´åˆã«ã¯ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®HPã¯è¡Œå‹•ã‚’ã™ã‚‹åº¦ã«å°‘ã—ãšã¤å›å¾©ã—ã¦ã„ãã¾ã™ã€‚

ã¤ã¾ã‚Šã€æ•µã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‹ã‚‰ã®æ”»æ’ƒãªã©ã«ã‚ˆã£ã¦HPãŒæ¸›å°‘ã—ã¦ã‚‚ãƒ€ãƒ³ã‚¸ãƒ§ãƒ³ã‚’æ­©ãå›ã‚‹ãªã©è¡Œå‹•ã‚’è¡Œã£ã¦ã„ã‚Œã°HPã‚’è‡ªç„¶å›å¾©ã§ãã¾ã™ã€‚

ã—ã‹ã—ã€æº€è…¹åº¦ã¯ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒè¡Œå‹•ã™ã‚‹åº¦ã«å°‘ã—ãšã¤æ¸›ã£ã¦ã„ãã€æº€è…¹åº¦ãŒ0ã«ãªã£ã¦ã—ã¾ã†ã¨ã€HPã¯è¡Œå‹•ã‚’ã™ã‚‹åº¦ã«å°‘ã—ãšã¤å›å¾©ã™ã‚‹ã®ã§ã¯ãªãã€æ¸›å°‘ã—ã¦ã„ãã¾ã™ã€‚

ãã—ã¦ã€ãã®çŠ¶æ…‹ã‚’æ”¾ç½®ã—ã¦HPãŒ0ã«ãªã£ã¦ã—ã¾ã†ã¨ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯æ­»äº¡ã—ã€ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ã¨ãªã‚Šã¾ã™ã€‚

ã“ã‚Œã«ã‚ˆã‚Šã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯HPã ã‘ã§ãªãã€æº€è…¹åº¦ã¨ã„ã†ã‚‚ã®ã‚‚ç®¡ç†ã—ã¦ã„ã‹ãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ã€‚

ã‚²ãƒ¼ãƒ ãŒã‚ˆã‚Šè¤‡é›‘ãªã‚‚ã®ã¨ãªã‚Šã€ã‚ˆã‚Šé¢ç™½ã„ã‚‚ã®ã¨ãªã‚Šã¾ã™ï¼ˆãªã‚‹ã¨æ€ã„ã¾ã™ï¼‰ã€‚

---

ãã‚Œã§ã¯æº€è…¹åº¦ã®å®Ÿè£…ã‚’è¡Œã„ã¾ã—ã‚‡ã†ã€‚

`Player`ã‚¯ãƒ©ã‚¹ã«æº€è…¹åº¦ã®å®Ÿè£…ã«å¿…è¦ãªã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’è¿½åŠ ã—ã¾ã™ã€‚

`Player`ã‚¯ãƒ©ã‚¹ã‚’ä¸‹ã®ã‚ˆã†ã«å¤‰æ›´ã—ã¾ã™ã€‚

ä¸‹ã®ã‚ˆã†ãªã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚

* `energybase`ãƒ»ãƒ»ãƒ»ãƒ™ãƒ¼ã‚¹ã®æº€è…¹åº¦ã§ã™ã€‚æº€è…¹åº¦ã¯ã¨ã‚Šã‚ãˆãšãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ã«ã‚ˆã£ã¦ã¯å¤‰å‹•ã—ãªã„ã‚‚ã®ã¨ã—ã¾ã™ã€‚ã§ã™ã‹ã‚‰ã€ãƒ™ãƒ¼ã‚¹ã®æº€è…¹åº¦ã¯åŸºæœ¬çš„ã«åˆæœŸå€¤ã®`100`ã‹ã‚‰å¤‰åŒ–ã—ãªã„ã“ã¨ã«ãªã‚Šã¾ã™ã€‚
* `energyext`ãƒ»ãƒ»ãƒ»ä»˜åŠ çš„ãªæº€è…¹åº¦ã§ã™ã€‚
* `hp_fraction`ãƒ»ãƒ»ãƒ»æº€è…¹åº¦ãŒ1ä»¥ä¸Šã§ã‚ã‚‹å ´åˆã«ã¯HPãŒè‡ªç„¶å›å¾©ã—ã¾ã™ãŒã€å›å¾©é‡ã®ç«¯æ•°ï¼ˆ1æœªæº€ã®å€¤ï¼‰ã‚’æ ¼ç´ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã—ã¾ã™ã€‚ãã—ã¦ã€ã‚²ãƒ¼ãƒ ã«ãŠã‘ã‚‹HPã¯1å˜ä½ã§å¤‰å‹•ã—ã¾ã™ã€‚
* `energy`ãƒ»ãƒ»ãƒ»ç¾åœ¨ã®æº€è…¹åº¦ã‚’è¡¨ã™ã‚‚ã®ã¨ã—ã¾ã™ã€‚
* `energy_turn`ãƒ»ãƒ»ãƒ»æº€è…¹åº¦ã¯10ã‚¿ãƒ¼ãƒ³ã”ã¨ã«1æ¸›ã£ã¦ã„ãã‚‚ã®ã¨ã—ã¾ã™ã€‚ã“ã®å€¤ã¯ã‚¿ãƒ¼ãƒ³ã‚’ç®¡ç†ã—ã¾ã™ã€‚
* `energyfull`ãƒ»ãƒ»ãƒ»æœ€å¤§æº€è…¹åº¦ã‚’è¡¨ã—ã¾ã™ã€‚

```js
class Player {
	constructor () {
		this.depth = 0;
		this.x = 12;
		this.y = 17;

		this.level = 1;
		this.hpbase = 16;
		this.hpext = 0;
		this.energybase = 100;
		this.energyext = 0;
		this.atkbase = 4;
		this.atkext = 0;
		this.defbase = 4;
		this.defext = 0;
		this.expfull = 4;

		this.hp = this.hpfull;
		this.hp_fraction = 0;
		this.energy = this.energyfull;
		this.energy_turn = 0;
		this.exp = 0;
	}

	get hpfull () {
		return this.hpbase + this.hpext;
	}

	get energyfull () {
		return this.energybase + this.energyext;
	}

	get atk () {
		return this.atkbase + this.atkext;
	}

	get def () {
		return this.defbase + this.defext;
	}
}
```

ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æº€è…¹åº¦ã‚’ã‚²ãƒ¼ãƒ ç”»é¢ã«æç”»ã—ã¾ã™ã€‚

ã‚²ãƒ¼ãƒ ç”»é¢ã«æç”»ã™ã‚‹ãƒ†ã‚­ã‚¹ãƒˆã‚’ä¿æŒã™ã‚‹å¤‰æ•°ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```js
var TEXT_ENERGY = 'æº€è…¹åº¦';
```

`draw`é–¢æ•°ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æç”»å‡¦ç†ã‚’ä¸‹ã®ã‚ˆã†ã«å¤‰æ›´ã—ã¾ã™ã€‚

```js
	con.save();
	con.textBaseline = 'top';
	con.textAlign = 'left';
	con.font = '24px consolas';
	con.fillStyle = 'white';
	con.translate(SX * PX, 0);
	con.fillText(player.depth + 'F', 8, (24 + 6) * 0 + 8);
	con.fillText(TEXT_LEVEL + 'ï¼š' + player.level, 8, (24 + 6) * 1 + 8);
	con.fillText(TEXT_HP + 'ï¼š' + player.hp + '/' + player.hpfull, 8, (24 + 6) * 2 + 8);
	con.fillText(TEXT_ENERGY + 'ï¼š' + player.energy + '/' + player.energyfull, 8, (24 + 6) * 3 + 8);
	con.fillText(TEXT_ATK + 'ï¼š' + player.atk, 8, (24 + 6) * 4 + 8);
	con.fillText(TEXT_DEF + 'ï¼š' + player.def, 8, (24 + 6) * 5 + 8);
	con.fillText(TEXT_EXP + 'ï¼š' + player.exp + '/' + player.expfull, 8, (24 + 6) * 6 + 8);
	con.restore();
```

æº€è…¹åº¦ã«é–¢ã™ã‚‹å‡¦ç†ã¯ã‚¿ãƒ¼ãƒ³ã”ã¨ã«è¡Œã„ã¾ã™ã€‚

ãªã®ã§ã€2ã¤ç›®ã®`keydown`ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ã®æœ€å¾Œã«è¡Œã†ã®ãŒé©åˆ‡ã§ã™ã€‚

ã¾ãšå¿…è¦ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’å®šç¾©ã—ã¾ã™ã€‚

```js
var MSG_ENERGY20 = 'ãŠè…¹ãŒæ¸›ã£ã¦ãã¾ã—ãŸã€‚';
var MSG_ENERGY10 = 'ãŠè…¹ãŒãƒšã‚³ãƒšã‚³ã§ã™ã€‚';
var MSG_ENERGY0 = 'ãŠè…¹ãŒæ¸›ã£ã¦æ­»ã«ãã†ã§ã™ã€‚';
```

ãã—ã¦ã€2ã¤ç›®ã®`keydown`ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ã‚’ä¸‹ã®ã‚ˆã†ã«å¤‰æ›´ã—ã¾ã™ã€‚

HPã¯1ã‚¿ãƒ¼ãƒ³ã”ã¨ã«0.5%å›å¾©ã¾ãŸã¯æ¸›å°‘ã™ã‚‹ã‚‚ã®ã¨ã—ã¾ã™ã€‚

æº€è…¹åº¦ãŒ0ã§ã‚ã‚‹å ´åˆã«ã¯HPãŒæ¸›å°‘ã—ã¾ã™ã€‚HPãŒ0ä»¥ä¸‹ã«ãªã£ãŸå ´åˆã¯ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ã§ã™ã€‚

æº€è…¹åº¦ãŒ1ä»¥ä¸Šã§ã‚ã‚‹å ´åˆã«ã¯HPãŒå›å¾©ã—ã¾ã™ã€‚ã¾ãŸã€10ã‚¿ãƒ¼ãƒ³ã«1æº€è…¹åº¦ãŒæ¸›å°‘ã—ã¾ã™ã€‚æº€è…¹åº¦ãŒå°‘ãªããªã‚ŠéããŸå ´åˆã«ã¯è­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‡ºåŠ›ã—ã¾ã™ã€‚

```js
	c.on('keydown', function (e) {
ï¼ˆçœç•¥ï¼‰
		if (!gameover) {
			var delta = player.hpfull * 0.005;
			if (player.energy === 0) {
				player.energy_turn = 0;
				player.hp_fraction -= delta;
				if (player.hp_fraction <= -1) {
					player.hp--;
					player.hp_fraction += 1;
				}
				if (player.hp <= 0) {
					player.hp = 0;
					gameover = true;
					add_message({
						text: MSG_DIE,
						type: 'special'
					});
				}
			}
			else {
				player.energy_turn++;
				if (player.energy_turn === 10) {
					player.energy_turn = 0;
					player.energy--;
					if (player.energy === 20) {
						add_message({
							text: MSG_ENERGY20,
							type: 'normal'
						});
					}
					else if (player.energy === 10) {
						add_message({
							text: MSG_ENERGY10,
							type: 'normal'
						});
					}
					else if (player.energy === 0) {
						add_message({
							text: MSG_ENERGY0,
							type: 'important'
						});
					}
				}

				if (player.hp < player.hpfull) {
					player.hp_fraction += delta;
					if (player.hp_fraction >= 1) {
						player.hp++;
						player.hp_fraction -= 1;
					}
				}
				else {
					player.hp_fraction = 0;
				}
			}
		}

		draw(con, env);
	});
```

ã“ã‚Œã§æº€è…¹åº¦ã®å‡¦ç†ãŒå®Ÿè£…ã§ãã¾ã—ãŸã€‚







### ä»Šå›ã¯ã“ã“ã¾ã§

ä»Šå›ã¯ã“ã“ã¾ã§ã§ã™ã€‚

`game.js`ã¯ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚é‚ã«`game.js`ã®è¡Œæ•°ãŒ1000è¡Œã‚’è¶…ãˆã¾ã—ãŸã€‚ã ã‚“ã ã‚“è¤‡é›‘ãªãƒ—ãƒ­ã‚°ãƒ©ãƒ ã«ãªã£ã¦ããŸã‚ˆã†ãªæ°—ãŒã—ã¾ã™ã€‚

```js
ï»¿```

æ¬¡å›ã¯ã‚¢ã‚¤ãƒ†ãƒ ã«ã¤ã„ã¦è€ƒãˆãŸã„ã¨æ€ã„ã¾ã™ã€‚
