## ローグライクゲームを作ってみるその6 ゲームメッセージとプレイヤーのステータス

### 過去記事一覧

* [その1 タイトル画面](https://qiita.com/pizyumi/items/3526fddd4f18a462e1ae)
* [その2 ダンジョン・プレイヤーの生成と描画](https://qiita.com/pizyumi/items/2562a159f497a608615b)
* [その3 プレイヤーの移動]()
* [その4 ダンジョンのランダム生成]()
* [その5 ダンジョンのサイズ]()

現在のコードについては前回の記事の最後の項を参照してください。

### ゲームメッセージ

今回は初めにゲームメッセージを出力する機能を実装します。

ゲームメッセージはゲーム画面の右下の部分に描画することにします。

ゲームメッセージを保持するための`messages`変数を用意します。ゲームメッセージはメッセージを表すオブジェクトの配列として保持することにします。

```js
var messages = null;
```

保持するメッセージの最大数を`NUM_MESSAGE`変数で定義します。保持するメッセージの最大数は8個とします。

```js
var NUM_MESSAGE = 8;
```

メッセージを追加するための`add_message`関数を実装します。

第1引数にはメッセージを表すオブジェクトを渡すものとします。

メッセージを表すオブジェクトは下のようなプロパティを有するものとします。

* `text`・・・メッセージテキストです。
* `type`・・・メッセージの種類です。
* `repeat`・・・メッセージの繰り返し回数を表します。同じメッセージが連続して出力された場合には繰り返し回数を増加させることによって同じメッセージが連続して出力されたことを表現することにします。

この関数では追加されたメッセージが直前に追加されたメッセージと同じものである場合には直前に追加されたメッセージの繰り返し回数を`1`増加させ、直前に追加されたメッセージと異なるものである場合には`messages`変数にメッセージを追加します。

ただし、保持されているメッセージが8個より多い場合には古いメッセージを削除するようにします。

```js
function add_message (message) {
	var l = messages[messages.length - 1];
	if (message.text === l.text && message.type === l.type) {
		if (!l.repeat) {
			l.repeat = 2;
		}
		else {
			l.repeat++;
		}
	}
	else {
		messages.push(message);
		while (messages.length > NUM_MESSAGE) {
			messages.shift();
		}
	}
}
```

`draw`関数にメッセージを描画する処理を追加します。

メッセージの種類に応じてメッセージの文字色を変更します。

また、メッセージに繰り返し回数が設定されている場合には繰り返し回数も表記するようにします。

```js
	con.save();

	con.textBaseline = 'top';
	con.textAlign = 'left';
	con.font = '16px consolas';
	con.translate(SX * PX, SCREEN_Y - ((16 + 6) * NUM_MESSAGE + 8 * 2));
	for (var i = 0; i < messages.length; i++) {
		if (messages[i].type === 'normal') {
			con.fillStyle = 'white';
		}
		else if (messages[i].type === 'special') {
			con.fillStyle = 'yellow';
		}
		else {
			throw new Error('not supported.');
		}
		var text = messages[i].text;
		if (messages[i].repeat) {
			text += '（' + 'x' + messages[i].repeat + '）';
		}
		con.fillText(text, 8, (16 + 6) * i + 8);
	}

	con.restore();
```

これでゲームメッセージを出力する機能が実装できました。

### メッセージの追加

実際に幾つかメッセージを出力してみましょう。

まず、メッセージテキストを定義します。

3つのメッセージを出力するようにしてみます。

1つ目のメッセージは新しいゲームを開始した時に出力します。

2つ目のメッセージは下り階段を降りた場合に出力します。

3つ目のメッセージは壁に向かって歩こうとした場合に出力します。

```js
var MSG_INIT = 'あなたは目覚めました。';
var MSG_DOWNSTAIR = '下り階段を降りました。';
var MSG_WALL = '壁に阻まれました。';
```

1つ目のメッセージは`init`関数で追加します。

`init`関数を下のように変更します。

種類が`special`でテキストが`MSG_INIT`のメッセージを追加します。

```js
function init () {
	fields = [];
	fields[0] = create_field(0, [], seed);
	player = {
		depth: 0,
		x: 12,
		y: 17
	};
	messages = [{
		text: MSG_INIT,
		type: 'special'
	}];
}
```

2つ目と3つ目のメッセージは`keydown`イベントハンドラで追加します。

2つ目の`keydown`イベントハンドラを下のように変更します。

移動しようとしたマスの種類が壁であった場合に種類が`normal`でテキストが`MSG_WALL`のメッセージを追加します。

また、下り階段から1つ下の階に移動した場合に種類が`normal`でテキストが`MSG_DOWNSTAIR`のメッセージを追加します。

```js
	c.on('keydown', function (e) {
（省略）
		if (e.keyCode >= 37 && e.keyCode <= 40) {
（省略）
			if (x !== player.x || y !== player.y) {
				var block = fields[player.depth].blocks[x][y];
				if (B_CAN_STAND[block.base]) {
					player.x = x;
					player.y = y;

					draw(con, env);
				}
				else {
					if (block.base === B_WALL) {
						add_message({
							text: MSG_WALL,
							type: 'normal'
						});

						draw(con, env);
					}
				}
			}
		}
		else if (e.keyCode === 32) {
			var block = fields[player.depth].blocks[player.x][player.y];
			if (block.base === B_DOWNSTAIR) {
				player.depth++;
				if (!fields[player.depth]) {
					fields[player.depth] = create_field(player.depth, [{
						x: player.x,
						y: player.y
					}], seed);
				}

				add_message({
					text: MSG_DOWNSTAIR,
					type: 'normal'
				});

				draw(con, env);
			}
		}
	});
```

メッセージが表示されたゲーム画面は下のようになります。

![](01.jpg)

### プレイヤーのステータスの描画

次にプレイヤーのステータスを描画します。

といっても、現在プレイヤーの状態として存在する値は、`player`変数に格納される`depth`、`x`、`y`のみです。

この中で`x`と`y`は敢えてゲーム画面に表示する必要はありませんが、`depth`は表示すべきでしょう。

また、今後ゲームを開発していくにつれてプレイヤーの状態として様々なものが追加されていくことになるはずです。

その中の幾つかはゲーム画面に表示させるべきものとなるでしょう。

そこで、今後はゲーム画面の右上部分にプレイヤーのステータスを表示していくことにします。

今回はプレイヤーが何階のフロアにいるかを表示する処理を追加してみることにします。

`draw`関数に下のコードを追加します。

```js
	con.save();

	con.textBaseline = 'top';
	con.textAlign = 'left';
	con.font = '24px consolas';
	con.fillStyle = 'white';
	con.translate(SX * PX, 0);
	con.fillText(player.depth + '階', 8, (24 + 6) * 0 + 8);

	con.restore();
```

これでプレイヤーのいる階がゲーム画面に表示されるようになりました。

ゲーム画面は下のようになります。

![](02.jpg)

### 今回はここまで

今回はここまでです。

`game.js`は下のようになりました。

```js
﻿```

次回は敵モンスターについて考えたいと思います。
