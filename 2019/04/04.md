## ãƒ­ãƒ¼ã‚°ãƒ©ã‚¤ã‚¯ã‚²ãƒ¼ãƒ ã‚’ä½œã£ã¦ã¿ã‚‹ãã®4 ãƒ€ãƒ³ã‚¸ãƒ§ãƒ³ã®ãƒ©ãƒ³ãƒ€ãƒ ç”Ÿæˆ

### éå»è¨˜äº‹ä¸€è¦§

* [ãã®1 ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢](https://qiita.com/pizyumi/items/3526fddd4f18a462e1ae)
* [ãã®2 ãƒ€ãƒ³ã‚¸ãƒ§ãƒ³ãƒ»ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ç”Ÿæˆã¨æç”»](https://qiita.com/pizyumi/items/2562a159f497a608615b)
* [ãã®3 ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ç§»å‹•](https://qiita.com/pizyumi/items/07447c9a1a52b0d9a228)

ç¾åœ¨ã®ã‚³ãƒ¼ãƒ‰ã«ã¤ã„ã¦ã¯å‰å›ã®è¨˜äº‹ã®æœ€å¾Œã®é …ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

### è¤‡æ•°ã®ãƒ•ãƒ­ã‚¢

ä»Šå›ã¯ãƒ€ãƒ³ã‚¸ãƒ§ãƒ³ã®ãƒ©ãƒ³ãƒ€ãƒ ç”Ÿæˆã‚’ã‚„ã£ã¦ã¿ã‚ˆã†ã¨æ€ã„ã¾ã™ãŒã€ãã®å‰ã«è¤‡æ•°ã®ãƒ•ãƒ­ã‚¢ã‚’ç§»å‹•ã§ãã‚‹ã‚ˆã†ã«ã—ã‚ˆã†ã¨æ€ã„ã¾ã™ã€‚

ç¾åœ¨ã¯1ã¤ã®ãƒ•ãƒ­ã‚¢ã—ã‹ç”Ÿæˆã•ã‚Œãšã€ãã®ãƒ•ãƒ­ã‚¢ã‚’ç§»å‹•ã™ã‚‹ã“ã¨ã—ã‹ã§ãã¾ã›ã‚“ã€‚

ã“ã‚Œã‚’ä¸‹ã®ã‚ˆã†ã«å¤‰æ›´ã—ã¾ã™ã€‚

* å…¨ã¦ã®ãƒ•ãƒ­ã‚¢ã«ã¯1ã¤ã®ä¸‹ã‚Šéšæ®µãŒè¨­ç½®ã•ã‚Œã€ãã®éšæ®µã‹ã‚‰1ã¤ä¸‹ã®ãƒ•ãƒ­ã‚¢ï¼ˆéšï¼‰ã«ç§»å‹•ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚
* ã¨ã‚Šã‚ãˆãšä¸Šã‚Šéšæ®µã¯è¨­ç½®ã—ãªã„ï¼ˆä¸€åº¦ä¸‹ã®ãƒ•ãƒ­ã‚¢ã«ç§»å‹•ã—ã¦ã—ã¾ã†ã¨ã€ä¸Šã®ãƒ•ãƒ­ã‚¢ã«æˆ»ã‚‹ã“ã¨ã¯ã§ããªã„ï¼‰ã€‚

ã¾ãšã€ç¾åœ¨ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã¯ãƒ•ãƒ­ã‚¢ãŒ1ã¤ã§ã‚ã‚‹ã“ã¨ã‚’å‰æã¨ã—ã¦çµ„ã‚“ã§ã„ãŸã®ã§ã€è¤‡æ•°ã®ãƒ•ãƒ­ã‚¢ï¼ˆéšï¼‰ã«å¯¾å¿œã§ãã‚‹ã‚ˆã†ã«å¤‰æ›´ã—ã¾ã™ã€‚

ç¾åœ¨ã¯`field`å¤‰æ•°ã«ãƒ•ãƒ­ã‚¢ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ ¼ç´ã—ã¦ã„ã¾ã—ãŸãŒã€ä»Šå¾Œã¯è¤‡æ•°ã®ãƒ•ãƒ­ã‚¢ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ ¼ç´ã™ã‚‹ã“ã¨ã«ãªã‚‹ãŸã‚ã“ã®å¤‰æ•°ã®åç§°ã‚’`fields`ã«å¤‰æ›´ã—ã¾ã™ã€‚

```js
var fields = null;
```

ãã—ã¦ã€`init`é–¢æ•°ã‚’ä¸‹ã®ã‚ˆã†ã«å¤‰æ›´ã—ã¾ã™ã€‚

`fields`å¤‰æ•°ã¯é…åˆ—ã¨ãªã‚Šã€å…ˆé ­ã®è¦ç´ ã¨ã—ã¦æœ€åˆã®ãƒ•ãƒ­ã‚¢ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ ¼ç´ã—ã¾ã™ã€‚

ã¾ãŸã€`player.depth`ã‚’è¿½åŠ ã—ã¾ã™ã€‚ã“ã‚Œã¯ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒç¾åœ¨ã„ã‚‹éšæ•°ã‚’è¡¨ã™ã“ã¨ã«ã—ã¾ã™ã€‚æœ€åˆã®ãƒ•ãƒ­ã‚¢ã®éšæ•°ã¯`0`ã¨ã—ã¾ã™ã€‚ãã®ãŸã‚ã€`player.depth`ã®åˆæœŸå€¤ã¯`0`ã¨ãªã‚Šã¾ã™ã€‚ã“ã®å€¤ã¯ä¸‹ã‚Šéšæ®µã‚’ä½¿ã£ã¦1ã¤ä¸‹ã®éšã«ç§»å‹•ã™ã‚‹ã“ã¨ã«ã‚ˆã£ã¦`1`å¢—åŠ ã™ã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚

```js
function init () {
	fields = [];
	fields[0] = create_field();
	player = {
		depth: 0, 
		x: 12,
		y: 17
	};
}
```

ãã—ã¦ã€ä»Šã¾ã§`field`å¤‰æ•°ã‚’ä½¿ç”¨ã—ã¦ãƒ•ãƒ­ã‚¢ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‚ç…§ã—ã¦ã„ãŸã‚³ãƒ¼ãƒ‰ã‚’`fields`å¤‰æ•°ã‚’ä½¿ç”¨ã™ã‚‹ã‚ˆã†ã«å¤‰æ›´ã—ã¾ã™ã€‚

2ã¤ç›®ã®`keydown`ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ã®`field`å¤‰æ•°ã‚’ä½¿ç”¨ã—ã¦ã„ãŸéƒ¨åˆ†ã‚’ä¸‹ã®ã‚ˆã†ã«å¤‰æ›´ã—ã¾ã™ã€‚

```js
	c.on('keydown', function (e) {
ï¼ˆçœç•¥ï¼‰
		if (e.keyCode >= 37 && e.keyCode <= 40) {
ï¼ˆçœç•¥ï¼‰
			if (x !== player.x || y !== player.y) {
				var block = fields[player.depth].blocks[x][y];
				if (B_CAN_STAND[block.base]) {
					player.x = x;
					player.y = y;
				}
				else {
					return;
				}
			}
			else {
				return;
			}
		}
		else {
			return;
		}

		draw(con, env);
	});
```

ã¾ãŸã€`draw`é–¢æ•°ã®`field`å¤‰æ•°ã‚’ä½¿ç”¨ã—ã¦ã„ãŸéƒ¨åˆ†ã‚’ä¸‹ã®ã‚ˆã†ã«å¤‰æ›´ã—ã¾ã™ã€‚

```js
function draw (con, env) {
ï¼ˆçœç•¥ï¼‰
	for (var i = 0; i < LX; i++) {
		for (var j = 0; j < LY; j++) {
			var block = fields[player.depth].blocks[i][j];
			if (block.base === B_FLOOR) {
				con.fillStyle = 'white';
				con.beginPath();
				con.arc((i + 0.5) * PX, (j + 0.5) * PY, 1, 0, Math.PI * 2);
				con.closePath();
				con.fill();
			}
			else if (block.base === B_WALL) {
				con.strokeStyle = 'white';
				con.strokeRect(i * PX, j * PY, PX, PY);
				con.beginPath();
				con.moveTo(i * PX, j * PY);
				con.lineTo((i + 1) * PX, (j + 1) * PY);
				con.moveTo((i + 1) * PX, j * PY);
				con.lineTo(i * PX, (j + 1) * PY);
				con.closePath();
				con.stroke();
			}
		}
	}
ï¼ˆçœç•¥ï¼‰
}
```

### ä¸‹ã‚Šéšæ®µã®ç”Ÿæˆ

ãƒ€ãƒ³ã‚¸ãƒ§ãƒ³å†…ã«ä¸‹ã‚Šéšæ®µã‚’ç”Ÿæˆã—ã¾ã™ã€‚

ã¾ãšä¸‹ã‚Šéšæ®µã®å®šç¾©ã‚’è¡Œã„ã¾ã™ã€‚

ä¸‹ã‚Šéšæ®µã®ãƒã‚¹ã®ç¨®é¡ã®å€¤ã¯`2`ã¨ã—ã¾ã™ã€‚

```js
var B_DOWNSTAIR = 2;
```

ä¸‹ã‚Šéšæ®µã¯ç§»å‹•ã§ãã‚‹ãƒã‚¹ã§ã™ã€‚

```js
B_CAN_STAND[B_DOWNSTAIR] = true;
```

`create_field`é–¢æ•°ã‚’ä¸‹ã®ã‚ˆã†ã«å¤‰æ›´ã—ã¾ã™ã€‚

`(12, 5)`ã«ä¸‹ã‚Šéšæ®µã‚’ç”Ÿæˆã™ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

```js
function create_field () {
	var blocks = [];
	for (var i = 0; i < LX; i++) {
		blocks[i] = [];
		for (var j = 0; j < LY; j++) {
			if ((i === 0 || j === 0) || (i === LX -1 || j === LY - 1)) {
				blocks[i][j] = {
					base: B_WALL
				};
			}
			else if (i === 12 && j === 5) {
				blocks[i][j] = {
					base: B_DOWNSTAIR
				};
			}
			else {
				blocks[i][j] = {
					base: B_FLOOR
				};
			}
		}
	}

	return {
		blocks: blocks
	};
}
```

### ä¸‹ã‚Šéšæ®µã®æç”»

ä¸‹ã‚Šéšæ®µã®æç”»ã«ã¯ãƒãƒƒãƒˆã§é©å½“ã«æ‹¾ã£ã¦ããŸã‚²ãƒ¼ãƒ ç´ æã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã«ã—ã¾ã™ï¼ˆã©ã“ã§æ‹¾ã£ãŸã‹å¿˜ã‚Œã¾ã—ãŸãƒ»ãƒ»ãƒ»ï¼‰ã€‚

ä¸‹ã®ã‚ˆã†ãªã‚²ãƒ¼ãƒ ç´ æã‚’ä½¿ç”¨ã—ã¾ã™ã€‚ã“ã®ä¸­ã«å«ã¾ã‚Œã¦ã„ã‚‹éšæ®µã®ç”»åƒã‚’åˆ©ç”¨ã—ã¾ã™ã€‚

![](Dungeon_B_Freem7.png)

ã“ã®ç”»åƒã®ãƒ•ã‚¡ã‚¤ãƒ«åã¯`Dungeon_B_Freem7.png`ã¨ã—ã¾ã™ã€‚

ã¾ãšã€ç”»åƒã®èª­ã¿è¾¼ã¿ã‚’è¡Œã„ã¾ã™ã€‚

```js
var img = new Image();
img.src = 'Dungeon_B_Freem7.png';
```

ãã—ã¦ã€`draw`é–¢æ•°ã‚’ä¸‹ã®ã‚ˆã†ã«å¤‰æ›´ã—ã¾ã™ã€‚

ãƒã‚¹ãŒä¸‹ã‚Šéšæ®µã§ã‚ã‚‹å ´åˆã®å‡¦ç†ã‚’è¿½åŠ ã—ã¾ã™ã€‚ãƒã‚¹ã«ç”»åƒã‚’æç”»ã—ã¾ã™ã€‚

```js
function draw (con, env) {
ï¼ˆçœç•¥ï¼‰
	for (var i = 0; i < LX; i++) {
		for (var j = 0; j < LY; j++) {
			var block = fields[player.depth].blocks[i][j];
			if (block.base === B_FLOOR) {
ï¼ˆçœç•¥ï¼‰
			}
			else if (block.base === B_WALL) {
ï¼ˆçœç•¥ï¼‰
			}
			else if (block.base === B_DOWNSTAIR) {
				con.drawImage(img, 4 * 32, 5 * 32, 32, 32, i * PX, j * PY, PX, PY);
			}
		}
	}
ï¼ˆçœç•¥ï¼‰
}
```

ã“ã‚Œã§ã€ã‚²ãƒ¼ãƒ ç”»é¢ã¯ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

![](01.png)

### ä¸‹ã‚Šéšæ®µã®å‹•ä½œ

æ¬¡ã«ã€ä¸‹ã‚Šéšæ®µã‚’é™ã‚Šã‚‹å‹•ä½œã‚’å®Ÿè£…ã—ã¾ã™ã€‚

ä¸‹ã‚Šéšæ®µã‚’é™ã‚Šã‚‹ã«ã¯ä¸‹ã‚Šéšæ®µã®ä¸Šã§ã‚¹ãƒšãƒ¼ã‚¹ã‚­ãƒ¼ã‚’æŠ¼ã™ã‚‚ã®ã¨ã—ã¾ã™ã€‚

2ã¤ç›®ã®`keydown`ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ã«ã‚¹ãƒšãƒ¼ã‚¹ã‚­ãƒ¼ãŒæŠ¼ã•ã‚Œã¦ã„ã‚‹å ´åˆã®å‡¦ç†ã‚’è¿½åŠ ã—ã¾ã™ã€‚ã‚¹ãƒšãƒ¼ã‚¹ã‚­ãƒ¼ã®`keyCode`ã¯`32`ã§ã™ã€‚

```js
	c.on('keydown', function (e) {
ï¼ˆçœç•¥ï¼‰
		if (e.keyCode >= 37 && e.keyCode <= 40) {
ï¼ˆçœç•¥ï¼‰
		}
		else if (e.keyCode === 32) {
			var block = fields[player.depth].blocks[player.x][player.y];
			if (block.base === B_DOWNSTAIR) {
				player.depth++;
				if (!fields[player.depth]) {
					fields[player.depth] = create_field();
				}
			}
		}
		else {
			return;
		}

		draw(con, env);
	});
```

### ä¹±æ•°ç”Ÿæˆ

æ¬¡ã«ã€ä¹±æ•°ç”Ÿæˆã«ã¤ã„ã¦è€ƒãˆã¾ã—ã‚‡ã†ã€‚

ãƒ€ãƒ³ã‚¸ãƒ§ãƒ³ã®ãƒ©ãƒ³ãƒ€ãƒ ç”Ÿæˆã‚’è¡Œã†ãŸã‚ã«ã¯ä¹±æ•°ã®ç”Ÿæˆã¯å¿…é ˆã§ã™ã€‚

JavaScriptã«ã¯`Math.random`ã¨ã„ã†ä¹±æ•°ã‚’å–å¾—ã™ã‚‹ãŸã‚ã®é–¢æ•°ãŒç”¨æ„ã•ã‚Œã¦ã„ã¾ã™ãŒã€ã“ã®é–¢æ•°ã¯ã¡ã‚‡ã£ã¨ä½¿ã„ã«ãã„ã§ã™ã€‚

ã¨ã„ã†ã®ã¯ã€ã“ã®é–¢æ•°ã¯æ¯å›ç•°ãªã‚‹å€¤ã‚’è¿”ã™ãŸã‚ã€å†ç¾æ€§ãŒãªã„ã®ã§ã™ã€‚

å†ç¾æ€§ãŒãªã„ã¨ã€ãƒ©ãƒ³ãƒ€ãƒ ç”Ÿæˆã•ã‚ŒãŸã‚ã‚‹ãƒ€ãƒ³ã‚¸ãƒ§ãƒ³ã¨å…¨ãåŒã˜ãƒ€ãƒ³ã‚¸ãƒ§ãƒ³ã‚’å¾Œã§å†ã³ç”Ÿæˆã™ã‚‹ã¨ã„ã†ã®ãŒé›£ã—ãï¼ˆç¾å®Ÿçš„ã«ã¯ä¸å¯èƒ½ï¼‰ã€ã‚²ãƒ¼ãƒ é–‹ç™ºã«ãŠã„ã¦ã¯ä¸ä¾¿ã§ã™ï¼ˆãƒ­ãƒ¼ã‚°ãƒ©ã‚¤ã‚¯ã‚²ãƒ¼ãƒ ã®é–‹ç™ºã«ãŠã„ã¦ã¯å…¨ãåŒã˜æ§‹é€ ã®ãƒ€ãƒ³ã‚¸ãƒ§ãƒ³ã‚’ç¹°ã‚Šè¿”ã—ãƒ—ãƒ¬ã‚¤ã—ã¦ã¿ã¦ãƒ—ãƒ¬ã‚¤æ„Ÿã‚’æ¤œè¨¼ã™ã‚‹ã¨ã„ã†ã“ã¨ã‚‚å¿…è¦ã«ãªã£ã¦ãã‚‹ã¯ãšã§ã™ï¼‰ã€‚

ã‚²ãƒ¼ãƒ ã«ãŠã‘ã‚‹ãƒ©ãƒ³ãƒ€ãƒ ã¨ã„ã†ã®ã¯ãƒ©ãƒ³ãƒ€ãƒ ãªæ€§è³ªã‚’æŒã¤ã‚²ãƒ¼ãƒ ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆãƒ€ãƒ³ã‚¸ãƒ§ãƒ³ãªã©ï¼‰ã‚’ä½œã‚ŠãŸã„ã¨ã„ã†ã“ã¨ã§ã‚ã£ã¦ã€å¿…ãšã—ã‚‚æ¯å›ç•°ãªã‚‹ã‚²ãƒ¼ãƒ ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«ä½œã‚ŠãŸã„ã¨ã„ã†ã“ã¨ã§ã¯ãªã„ã®ã§ã™ã€‚

ã§ã™ã®ã§ã€ã‚²ãƒ¼ãƒ ã«ãŠã‘ã‚‹ä¹±æ•°ç”Ÿæˆã«ãŠã„ã¦ã¯ã€`Math.random`é–¢æ•°ã®ã‚ˆã†ãªç„¡æ¡ä»¶ã«ãƒ©ãƒ³ãƒ€ãƒ ãªå€¤ã‚’è¿”ã™ã‚‚ã®ã¯é©ã—ã¦ãŠã‚‰ãšã€ã‚·ãƒ¼ãƒ‰ã«åŸºã¥ã„ã¦ãƒ©ãƒ³ãƒ€ãƒ ãªå€¤ã‚’è¿”ã™ã‚‚ã®ãŒé©ã—ã¦ã„ã‚‹ã¨ã„ã†ã“ã¨ã«ãªã‚Šã¾ã™ã€‚

ã‚·ãƒ¼ãƒ‰ã«åŸºã¥ã„ãŸä¹±æ•°ç”Ÿæˆã®å ´åˆã€ã‚·ãƒ¼ãƒ‰ãŒåŒã˜ãªã‚‰ã°åŒã˜ä¹±æ•°åˆ—ãŒå¾—ã‚‰ã‚Œã¾ã™ã€‚ã¤ã¾ã‚Šã€ã‚·ãƒ¼ãƒ‰ã•ãˆé©åˆ‡ã«ç®¡ç†ã™ã‚Œã°å†ç¾æ€§ãŒå¾—ã‚‰ã‚Œã¾ã™ã€‚

ãªã®ã§ã€ã“ã®ã‚²ãƒ¼ãƒ ã§ã¯ã‚·ãƒ¼ãƒ‰ã«åŸºã¥ã„ã¦ç”Ÿæˆã•ã‚ŒãŸä¹±æ•°ã‚’ä½¿ã£ã¦ãƒ©ãƒ³ãƒ€ãƒ ãªã‚²ãƒ¼ãƒ ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ç”Ÿæˆã™ã‚‹ã“ã¨ã«ã—ã¾ã™ã€‚

ãã†ã™ã‚Œã°ã€ã‚·ãƒ¼ãƒ‰ã‚’è¨˜æ†¶ã—ã¦ãŠã‘ã°ä»¥å‰ç”Ÿæˆã•ã‚ŒãŸã‚‚ã®ã¨å…¨ãåŒã˜ã‚²ãƒ¼ãƒ ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å†ã³ç”Ÿæˆã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

ã—ã‹ã—ãªãŒã‚‰ã€1ã¤å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚

ãã‚Œã¯JavaScriptã«ã¯ã‚·ãƒ¼ãƒ‰ã«åŸºã¥ã„ãŸä¹±æ•°ç”Ÿæˆã‚’è¡Œã†æ©Ÿèƒ½ãŒæ¨™æº–ã§ã¯æä¾›ã•ã‚Œã¦ã„ãªã„ã¨ã„ã†ã“ã¨ã§ã™ã€‚

ãªã®ã§ã€ã‚·ãƒ¼ãƒ‰ã«åŸºã¥ã„ãŸä¹±æ•°ç”Ÿæˆã‚’è¡Œã†æ©Ÿèƒ½ã‚’è‡ªä½œã—ãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ã€‚

ã©ã†ã—ã¾ã—ã‚‡ã†ï¼Ÿ

---

ã±ã£ã¨æ€ã„ä»˜ã„ãŸã®ã¯ä¸‹ã®æ–¹æ³•ã§ã—ãŸã€‚

* å††å‘¨ç‡ã‚’ä½¿ã†ã€‚
* ãƒãƒƒã‚·ãƒ¥å€¤ã‚’ä½¿ã†ã€‚

ã“ã®ã‚²ãƒ¼ãƒ ã§ã¯ãƒãƒƒã‚·ãƒ¥å€¤ã‚’ä½¿ã†ã“ã¨ã«ã—ã¾ã™ã€‚

ã¤ã¾ã‚Šã€ä½•ã‚‰ã‹ã®ãƒãƒƒã‚·ãƒ¥é–¢æ•°ã§ã‚·ãƒ¼ãƒ‰ã®ãƒãƒƒã‚·ãƒ¥å€¤ã‚’å–ã‚Šã€ãã‚Œã‚’ä¹±æ•°ã¨ã—ã¦ä½¿ç”¨ã—ã¾ã™ã€‚

æ—©é€Ÿå®Ÿè£…ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

JavaScriptã«ã¯ãƒãƒƒã‚·ãƒ¥é–¢æ•°ã‚‚æ¨™æº–ã§ã¯ç”¨æ„ã•ã‚Œã¦ã„ã¾ã›ã‚“ã®ã§ã€ãƒãƒƒã‚·ãƒ¥å€¤ã‚’è¨ˆç®—ã™ã‚‹ãŸã‚ã«[jsSHA](https://github.com/Caligatio/jsSHA)ã¨ã„ã†ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã«ã—ã¾ã™ã€‚

ã‚²ãƒ¼ãƒ ã®HTMLãƒ•ã‚¡ã‚¤ãƒ«ã§jsSHAã®`sha256.js`ã‚’èª­ã¿è¾¼ã¿ã¾ã™ã€‚

```html
<script src="sha256.js"></script>
```

æ¬¡ã«ã‚·ãƒ¼ãƒ‰ã®ãƒãƒƒã‚·ãƒ¥å€¤ã‚’å–å¾—ã™ã‚‹`hash`é–¢æ•°ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

ç¬¬1å¼•æ•°ã¨ã—ã¦ã‚·ãƒ¼ãƒ‰ã‚’å–ã‚Šã¾ã™ã€‚ã‚·ãƒ¼ãƒ‰ã¯æ–‡å­—åˆ—ã§ãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ã€‚

ã‚·ãƒ¼ãƒ‰ã®SHA256ãƒãƒƒã‚·ãƒ¥å€¤ã‚’è¨ˆç®—ã—ã€è¿”ã—ã¾ã™ã€‚

```js
function hash (seed) {
	var sha256 = new jsSHA('SHA-256', 'TEXT');
	sha256.update(seed);
	return sha256.getHash('HEX');
}
```

ã“ã‚Œã ã‘ã§ã¯ä¸ä¾¿ãªã®ã§ã€ã‚·ãƒ¼ãƒ‰ã«åŸºã¥ã„ã¦å†ç¾æ€§ã®ã‚ã‚‹ä¹±æ•°ã‚’ç”Ÿæˆã™ã‚‹ã‚¯ãƒ©ã‚¹ã¨ã—ã¦`Random`ã‚¯ãƒ©ã‚¹ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã®ç¬¬1å¼•æ•°ã¨ã—ã¦ã‚·ãƒ¼ãƒ‰ã‚’å–ã‚Šã¾ã™ã€‚

`Random`ã‚¯ãƒ©ã‚¹ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¯ä¸‹ã®ã‚ˆã†ãªãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’æŒã¤ã“ã¨ã«ã—ã¾ã™ã€‚

* `seed`ãƒ»ãƒ»ãƒ»ã‚·ãƒ¼ãƒ‰ã‚’è¡¨ã—ã¾ã™ã€‚
* `hash`ãƒ»ãƒ»ãƒ»ä¹±æ•°ã®ç´ ã¨ãªã‚‹ãƒãƒƒã‚·ãƒ¥å€¤ã‚’è¡¨ã—ã¾ã™ã€‚
* `pointer`ãƒ»ãƒ»ãƒ»æ¬¡ã«ä¹±æ•°ã‚’ç”Ÿæˆã™ã‚‹å ´åˆã«ãƒãƒƒã‚·ãƒ¥å€¤ã®ã©ã®éƒ¨åˆ†ã‹ã‚‰ã‚’ä½¿ç”¨ã™ã‚‹ã‹ã‚’è¡¨ã—ã¾ã™ã€‚

```js
class Random {
	constructor (seed) {
		this.seed = seed;
		this.hash = hash(seed);
		this.pointer = 0;
	}
}
```

æ¬¡ã«`Random`ã‚¯ãƒ©ã‚¹ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

1ã¤ç›®ã¯`byte`ãƒ¡ã‚½ãƒƒãƒ‰ã§ã™ã€‚

`byte`ãƒ¡ã‚½ãƒƒãƒ‰ã¯ã‚·ãƒ¼ãƒ‰ã®ãƒãƒƒã‚·ãƒ¥å€¤ã‹ã‚‰é †ç•ªã«1ãƒã‚¤ãƒˆåˆ†ã®å€¤ã‚’åˆ‡ã‚Šå‡ºã—ã€æ•°å€¤ã¨ã—ã¦è¿”ã—ã¾ã™ã€‚

ã‚·ãƒ¼ãƒ‰ã®ãƒãƒƒã‚·ãƒ¥å€¤ã®å…¨ä½“ã‚’ä½¿ã„å°½ãã—ã¦ã—ã¾ã£ãŸå ´åˆã«ã¯ãƒãƒƒã‚·ãƒ¥å€¤è‡ªä½“ã®ãƒãƒƒã‚·ãƒ¥å€¤ã‚’å–å¾—ã—ã€ä»Šåº¦ã¯ãã®ãƒãƒƒã‚·ãƒ¥å€¤ã‚’ä½¿ã£ã¦ã„ãã¾ã™ã€‚

```js
	byte () {
		if (this.pointer === 64) {
			this.hash = hash(this.hash);
			this.pointer = 0;
		}
		var value = this.hash.substring(this.pointer, this.pointer + 2);
		this.pointer += 2;
		return parseInt(value, 16);
	}
```

2ã¤ç›®ã¯`num`ãƒ¡ã‚½ãƒƒãƒ‰ã§ã™ã€‚

`num`ãƒ¡ã‚½ãƒƒãƒ‰ã¯`0`ã‹ã‚‰ç¬¬1å¼•æ•°`max`ã¾ã§ã®æ•´æ•°ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«è¿”ã—ã¾ã™ã€‚ç¬¬1å¼•æ•°`max`ã¯`256`ã¾ã§ã«ã—ã‹å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚

```js
	num (max) {
		if (max <= 0) {
			throw new Error('max of random.num must be positive.');
		}
		else if (max <= 256) {
			return this.byte() % max;
		}
		else {
			throw new Error('not supported.');
		}
	}
```

3ã¤ç›®ã¯`fraction`ãƒ¡ã‚½ãƒƒãƒ‰ã§ã™ã€‚

`fraction`ãƒ¡ã‚½ãƒƒãƒ‰ã¯`0`ã‹ã‚‰`1`ã¾ã§ã®å°æ•°ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«è¿”ã—ã¾ã™ã€‚

```js
	fraction () {
		return this.byte() / 256;
	}
```

ä¸€å¿œã“ã®ã‚¯ãƒ©ã‚¹ã®å‹•ä½œã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹`test_random_class_byte`é–¢æ•°ã¨`test_random_class_num`é–¢æ•°ã‚’ä½œæˆã—ã¾ã—ãŸã€‚

```js
function test_random_class_byte () {
	var a = [68, 9, 150, 66, 71, 184, 42, 152,
		84, 31, 148, 195, 79, 121, 253, 235,
		87, 142, 108, 87, 64, 95, 18, 186,
		184, 92, 200, 43, 179, 155, 117, 136,
		209, 241, 173, 107, 190, 11, 178, 50];
	var r = new Random('yurina');
	for (var i = 0; i < a.length; i++) {
		if (r.byte() !== a[i]) {
			throw new Error('test_random_class_byte');
		}
	}
}

function test_random_class_num () {
	var a = [0, 1, 0, 2, 1, 4, 0, 0, 3, 1, 5, 3, 1, 9, 13, 11];
	var r = new Random('yurina');
	for (var i = 0; i < a.length; i++) {
		if (r.num(i + 1) !== a[i]) {
			throw new Error('test_random_class_num');
		}
	}
}
```

ã“ã‚Œã§ã‚·ãƒ¼ãƒ‰ã«åŸºã¥ã„ã¦ä¹±æ•°ç”ŸæˆãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

### ãƒ€ãƒ³ã‚¸ãƒ§ãƒ³ã®ãƒ©ãƒ³ãƒ€ãƒ ç”Ÿæˆ

æœ€å¾Œã«ã€ãƒ€ãƒ³ã‚¸ãƒ§ãƒ³ã®ãƒ©ãƒ³ãƒ€ãƒ ç”Ÿæˆã‚’ã‚„ã£ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

ãŸã ã—ã€0éšã¯ä»Šã¾ã§é€šã‚Šã®1ã¤ã®éƒ¨å±‹ã®ã¿ã‹ã‚‰æˆã‚‹ãƒ•ãƒ­ã‚¢ã¨ã—ã€1éšä»¥é™ã‚’ãƒ©ãƒ³ãƒ€ãƒ ç”Ÿæˆã™ã‚‹ã“ã¨ã«ã—ã¾ã™ã€‚

`create_field`é–¢æ•°ã‚’ä¸‹ã®ã‚ˆã†ã«å¤‰æ›´ã—ã¾ã™ã€‚

ç¬¬1å¼•æ•°ã«ã¯éšæ•°ã‚’æŒ‡å®šã—ã€ç¬¬2å¼•æ•°ã«ã¯1ã¤ä¸Šã®éšã®ä¸‹ã‚Šéšæ®µã®ä½ç½®ã‚’è¡¨ã™ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®é…åˆ—ã‚’æŒ‡å®šã—ã€ç¬¬3å¼•æ•°ã«ã¯ä¹±æ•°ç”Ÿæˆã®ãŸã‚ã®ã‚·ãƒ¼ãƒ‰ã‚’æŒ‡å®šã™ã‚‹ã‚‚ã®ã¨ã—ã¾ã™ã€‚

```js
function create_field (depth, upstairs, base_seed) {
	var random = new Random(base_seed + ',' + depth.toString(10));

	var blocks = [];
	for (var i = 0; i < LX; i++) {
		blocks[i] = [];
		for (var j = 0; j < LY; j++) {
			if ((i === 0 || j === 0) || (i === LX -1 || j === LY - 1)) {
				blocks[i][j] = {
					base: B_WALL
				};
			}
			else {
				blocks[i][j] = {
					base: B_FLOOR
				};
			}
		}
	}

	if (depth === 0) {
		blocks[12][5] = {
			base: B_DOWNSTAIR
		};

		return {
			blocks: blocks
		};
	}

	var rs = [{
		x1: 1,
		x2: LX - 2,
		y1: 1,
		y2: LY - 2
	}];
	var ers = [];
	var dps = [1, 1, 1, 1, 1, 1, 0.5, 0.5, 0.5, 0.5];
	while (rs.length > 0 && dps.length > 0) {
		var r = rs.shift();
		var nrs = split_room(blocks, r, dps.shift(), random);
		for (var i = 0; i < nrs.length; i++) {
			rs.push(nrs[i]);
		}
		if (nrs.length === 0) {
			ers.push(r);
		}
	}
	while (rs.length > 0) {
		ers.push(rs.shift());
	}

	var nds = 1;
	while (nds > 0) {
		var x = random.num(LX - 2) + 1;
		var y = random.num(LY - 2) + 1;
		var f = true;
		for (var i = 0; i < upstairs.length; i++) {
			if (x === upstairs[i].x && y === upstairs[i].y) {
				f = false;
				break;
			}
		}
		if (f) {
			blocks[x][y].base = B_DOWNSTAIR;
			nds--;
		}
	}

	for (var i = 0; i < upstairs.length; i++) {
		if (blocks[upstairs[i].x][upstairs[i].y].base = B_WALL) {
			blocks[upstairs[i].x][upstairs[i].y].base = B_FLOOR;
		}
	}

	return {
		blocks: blocks
	};
}
```

æœ€åˆã«ä¹±æ•°ã‚’ç”Ÿæˆã™ã‚‹`Random`ã‚¯ãƒ©ã‚¹ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆã—ã¦ã„ã¾ã™ã€‚ã“ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«æ¸¡ã™ã‚·ãƒ¼ãƒ‰ã¯ç¬¬3å¼•æ•°ã®ã‚·ãƒ¼ãƒ‰ã¨éšæ•°ã‚’`,`ã§çµåˆã—ãŸã‚‚ã®ã¨ã—ã¾ã™ã€‚ã¤ã¾ã‚Šã€ã‚·ãƒ¼ãƒ‰ã¯éšæ•°ã”ã¨ã«å¤‰ãˆã‚‹ã“ã¨ã«ã—ã¾ã™ã€‚

ãƒ•ãƒ­ã‚¢ã®ç«¯ãŒå¿…ãšå£ã«ãªã‚‹ã®ã¯ä»¥å‰ã¨åŒã˜ã§ã™ã€‚ã¾ãŸã€0éšã®å ´åˆã«ã¯`(12, 5)`ã‚’ä¸‹ã‚Šéšæ®µã«ã—ã¦é–¢æ•°ã‚’çµ‚äº†ã—ã¾ã™ã€‚

ãã‚Œä»¥å¤–ã®éšã®å ´åˆã«ã¯éƒ¨å±‹ã®åˆ†å‰²ã‚’è¡Œã„ã¾ã™ã€‚

ã¤ã¾ã‚Šã€æœ€åˆã«ãƒ•ãƒ­ã‚¢å…¨ä½“ã‚’1ã¤ã®éƒ¨å±‹ã¨è¦‹åšã—ã€ãã®éƒ¨å±‹ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«åˆ†å‰²ã—ã¦ã„ãã“ã¨ã§è¤‡æ•°ã®éƒ¨å±‹ã‹ã‚‰æˆã‚‹ãƒ©ãƒ³ãƒ€ãƒ ãªãƒ•ãƒ­ã‚¢ã‚’ç”Ÿæˆã—ã¾ã™ã€‚

éƒ¨å±‹ã¯`x1`ã€`x2`ã€`y1`ã€`y2`ã¨ã„ã†4ã¤ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’æœ‰ã™ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨ã—ã¦è¡¨ç¾ã—ã¦ã„ã¾ã™ã€‚

`dps`å¤‰æ•°ã®å€¤ã¯éƒ¨å±‹ã‚’åˆ†å‰²ã™ã‚‹ç¢ºç‡ã‚’è¡¨ã—ã¦ã„ã¾ã™ã€‚1å›ç›®ã®åˆ†å‰²ã«ãŠã„ã¦ã¯æœ€åˆã®è¦ç´ ã®å€¤ã‚’ä½¿ç”¨ã—ã€2å›ç›®ã®åˆ†å‰²ã«ãŠã„ã¦ã¯2ã¤ç›®ã®è¦ç´ ã®å€¤ã‚’ä½¿ç”¨ã—ã€ä»¥å¾ŒåŒæ§˜ã§ã™ã€‚ãã®ãŸã‚ã€éƒ¨å±‹ã®åˆ†å‰²ã¯æœ€å¤§ã§ã‚‚10å›ã—ã‹è¡Œã‚ã‚Œã¾ã›ã‚“ã€‚

éƒ¨å±‹ã®åˆ†å‰²ã¯`split_room`é–¢æ•°ã§è¡Œã„ã¾ã™ï¼ˆå¾Œè¿°ã—ã¾ã™ï¼‰ã€‚

`split_room`é–¢æ•°ã¯éƒ¨å±‹ãŒåˆ†å‰²ã§ããŸå ´åˆã«ã¯åˆ†å‰²ã•ã‚Œã¦ã§ããŸ2ã¤ã®éƒ¨å±‹ã‚’è¡¨ã™ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®é…åˆ—ã‚’è¿”ã—ã€åˆ†å‰²ã§ããªã‹ã£ãŸå ´åˆã«ã¯ç©ºã®é…åˆ—ã‚’è¿”ã—ã¾ã™ã€‚

æœ€çµ‚çš„ã«ç”Ÿæˆã•ã‚ŒãŸéƒ¨å±‹ã‚’è¡¨ã™ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯`eps`å¤‰æ•°ã«æ ¼ç´ã•ã‚Œã¾ã™ã€‚

éƒ¨å±‹ã®åˆ†å‰²ãŒçµ‚ã‚ã£ãŸã‚‰ã€ä¸‹ã‚Šéšæ®µã®ç”Ÿæˆã‚’è¡Œã„ã¾ã™ã€‚ä¸‹ã‚Šéšæ®µã®æ•°ã¯1ã¤ã§ã™ã€‚ãã—ã¦ã€ä½ç½®ã¯ãƒ©ãƒ³ãƒ€ãƒ ã«æ±ºã‚ã‚‹ã“ã¨ã«ã—ã¾ã™ï¼ˆãŸã ã—ã€ãƒ•ãƒ­ã‚¢ã®ç«¯ã‚’é™¤ãï¼‰ãŒã€1ã¤ä¸Šã®éšã®ä¸‹ã‚Šéšæ®µãŒã‚ã‚‹å ´æ‰€ã¯é¿ã‘ã‚‹ã“ã¨ã«ã—ã¾ã™ã€‚

æœ€å¾Œã«ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯ä¸‹ã‚Šéšæ®µã‚’é™ã‚ŠãŸçµæœã€1ã¤ä¸‹ã®éšã®åŒã˜ä½ç½®ã«ç§»å‹•ã™ã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚ã§ã™ã®ã§ã€ãã®ãƒã‚¹ã¯å£ã§ã‚ã£ã¦ã¯ãªã‚Šã¾ã›ã‚“ã€‚ãã®ãŸã‚ã€ã‚‚ã—å£ã«ãªã£ã¦ã„ã‚‹å ´åˆã«ã¯åºŠã«å¤‰æ›´ã—ã¾ã™ã€‚

ãã—ã¦ã€`split_room`é–¢æ•°ã¯ä¸‹ã®ã‚ˆã†ã«ã—ã¾ã™ã€‚

ã¾ãšæœ€åˆã®`if`æ–‡ã§ç¢ºç‡çš„ã«éƒ¨å±‹ã®åˆ†å‰²ã‚’è¡Œã†ã‚ˆã†ã«ã—ã¾ã™ã€‚

æ¬¡ã«`dir`å¤‰æ•°ã§éƒ¨å±‹ã‚’åˆ†å‰²ã™ã‚‹æ–¹å‘ï¼ˆéƒ¨å±‹ã‚’ç¸¦ã«åˆ†å‰²ã™ã‚‹ã‹æ¨ªã«åˆ†å‰²ã™ã‚‹ã‹ï¼‰ã‚’æ±ºå®šã—ã¾ã™ã€‚ç¸¦é•·ã™ãã‚‹éƒ¨å±‹ã¯å¿…ãšæ¨ªåˆ†å‰²ã—ã¾ã™ã—ã€æ¨ªé•·ã™ãã‚‹éƒ¨å±‹ã¯å¿…ãšç¸¦åˆ†å‰²ã—ã¾ã™ã€‚

ä½™ã‚Šã«éƒ¨å±‹ãŒç‹­ã„å ´åˆã«ã¯åˆ†å‰²ã‚’è¡Œã„ã¾ã›ã‚“ã€‚ååˆ†ã«éƒ¨å±‹ãŒåºƒã„å ´åˆã«ã¯ã‚ã‚‹ç¨‹åº¦ãƒ©ãƒ³ãƒ€ãƒ ãªä½ç½®ã§éƒ¨å±‹ã‚’2åˆ†å‰²ã—ã¾ã™ã€‚

éƒ¨å±‹ã‚’åˆ†å‰²ã™ã‚‹éš›ã«ã¯å˜ç´”ã«éƒ¨å±‹ã‚’å£ã§åŒºåˆ‡ã‚‹ã ã‘ã§ã¯ç•°ãªã‚‹éƒ¨å±‹ã®é–“ã‚’è¡Œãæ¥ã™ã‚‹ã“ã¨ãŒã§ããªããªã£ã¦ã—ã¾ã„ã¾ã™ã®ã§ã€1ãƒã‚¹ã ã‘ã¯åºŠã®ã¾ã¾ã«ã—ã¦ãŠãã¾ã™ã€‚ãã†ã™ã‚‹ã¨ãã®ãƒã‚¹ãŒéƒ¨å±‹ã‚’è¡Œãæ¥ã™ã‚‹ãŸã‚ã®é€šè·¯ã¨ãªã‚Šã¾ã™ã€‚

```js
function split_room (blocks, r, dp, random) {
	var ap = random.fraction();
	if (ap <= dp) {
		var dir = random.num(2);
		if (r.x2 - r.x1 > (r.y2 - r.y1) * 2) {
			dir = 0;
		}
		else if ((r.x2 - r.x1) * 2 < r.y2 - r.y1) {
			dir = 1;
		}

		if (dir === 0) {
			if (r.x2 - r.x1 <= 6) {
				return [];
			}

			var x = random.num(r.x2 - r.x1 - 6) + 3 + r.x1;
			if (blocks[x][r.y1 - 1].base !== B_WALL) {
				return [];
			}
			if (blocks[x][r.y2 + 1].base !== B_WALL) {
				return [];
			}
			var y = random.num(r.y2 - r.y1) + r.y1;
			for (var i = r.y1; i <= r.y2; i++) {
				if (i !== y) {
					blocks[x][i].base = B_WALL;
				}
			}

			var r1 = {
				x1: r.x1,
				x2: x - 1,
				y1: r.y1,
				y2: r.y2
			};
			var r2 = {
				x1: x + 1,
				x2: r.x2,
				y1: r.y1,
				y2: r.y2
			};
			var ord = random.num(2);
			if (ord === 0) {
				return [r1, r2];
			}
			else {
				return [r2, r1];
			}
		}
		else if (dir === 1) {
			if (r.y2 - r.y1 <= 6) {
				return [];
			}

			var y = random.num(r.y2 - r.y1 - 6) + 3 + r.y1;
			if (blocks[r.x1 - 1][y].base !== B_WALL) {
				return [];
			}
			if (blocks[r.x2 + 1][y].base !== B_WALL) {
				return [];
			}
			var x = random.num(r.x2 - r.x1) + r.x1;
			for (var i = r.x1; i <= r.x2; i++) {
				if (i !== x) {
					blocks[i][y].base = B_WALL;
				}
			}

			var r1 = {
				x1: r.x1,
				x2: r.x2,
				y1: r.y1,
				y2: y - 1
			};
			var r2 = {
				x1: r.x1,
				x2: r.x2,
				y1: y + 1,
				y2: r.y2
			};
			var ord = random.num(2);
			if (ord === 0) {
				return [r1, r2];
			}
			else {
				return [r2, r1];
			}
		}
	}
	return [];
}
```

ã“ã‚Œã§ã€éå¸¸ã«å˜ç´”ã§ã¯ã‚ã‚Šã¾ã™ãŒã€ãƒ©ãƒ³ãƒ€ãƒ ãªãƒ€ãƒ³ã‚¸ãƒ§ãƒ³ã‚’ç”Ÿæˆã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

ã‚ˆã‚Šè¤‡é›‘ãªãƒ€ãƒ³ã‚¸ãƒ§ãƒ³ã®ç”Ÿæˆã‚‚ä»Šå¾Œè€ƒãˆã¦ã„ããŸã„ã§ã™ã€‚

ãƒ©ãƒ³ãƒ€ãƒ ãƒ€ãƒ³ã‚¸ãƒ§ãƒ³ç”Ÿæˆé–¢æ•°ãŒå®Ÿè£…ã§ããŸã®ã§ã€ã“ã®é–¢æ•°ã‚’é©åˆ‡ã«ä½¿ç”¨ã§ãã‚‹ã‚ˆã†ã«ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’å¤‰æ›´ã—ã¾ã™ã€‚

ã¾ãšã‚·ãƒ¼ãƒ‰ã‚’ç”¨æ„ã—ã¾ã™ã€‚ã¨ã‚Šã‚ãˆãšã‚·ãƒ¼ãƒ‰ã¯ç¾åœ¨æ™‚åˆ»ã¨ã™ã‚‹ã“ã¨ã«ã—ã¾ã—ãŸã€‚

```js
var seed = Date.now().toString(10);
```

ãã—ã¦ã€`init`é–¢æ•°ã‚’ä¸‹ã®ã‚ˆã†ã«å¤‰æ›´ã—ã¾ã™ã€‚

`create_field`é–¢æ•°ã®å‘¼ã³å‡ºã—ã«ãŠã„ã¦é©åˆ‡ãªå¼•æ•°ã‚’æ¸¡ã™ã‚ˆã†ã«ã—ã¾ã™ã€‚

```js
function init () {
	fields = [];
	fields[0] = create_field(0, [], seed);
	player = {
		depth: 0,
		x: 12,
		y: 17
	};
}
```

ã¾ãŸã€2ã¤ç›®ã®`keydown`ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ã‚’ä¸‹ã®ã‚ˆã†ã«å¤‰æ›´ã—ã¾ã™ã€‚

ä¸Šã®`init`é–¢æ•°ã¨åŒæ§˜ã«`create_field`é–¢æ•°ã®å‘¼ã³å‡ºã—ã«ãŠã„ã¦é©åˆ‡ãªå¼•æ•°ã‚’æ¸¡ã™ã‚ˆã†ã«ã—ã¾ã™ã€‚

```js
	c.on('keydown', function (e) {
ï¼ˆçœç•¥ï¼‰
		if (e.keyCode >= 37 && e.keyCode <= 40) {
ï¼ˆçœç•¥ï¼‰
		}
		else if (e.keyCode === 32) {
			var block = fields[player.depth].blocks[player.x][player.y];
			if (block.base === B_DOWNSTAIR) {
				player.depth++;
				if (!fields[player.depth]) {
					fields[player.depth] = create_field(player.depth, [{
						x: player.x,
						y: player.y
					}, seed]);
				}
			}
		}
		else {
			return;
		}

		draw(con, env);
	});
```

[](https://codepen.io/pizyumi/pen/ZEEBodv)

<p class="codepen" data-height="600" data-theme-id="0" data-default-tab="result" data-user="pizyumi" data-slug-hash="ZEEBodv" style="height: 600px; box-sizing: border-box; display: flex; align-items: center; justify-content: center; border: 2px solid; margin: 1em 0; padding: 1em;" data-pen-title="roguelike-4-1">
  <span>See the Pen <a href="https://codepen.io/pizyumi/pen/ZEEBodv">
  roguelike-4-1</a> by pizyumi (<a href="https://codepen.io/pizyumi">@pizyumi</a>)
  on <a href="https://codepen.io">CodePen</a>.</span>
</p>
<script async src="https://static.codepen.io/assets/embed/ei.js"></script>

### ä»Šå›ã¯ã“ã“ã¾ã§

ä»Šå›ã¯ã“ã“ã¾ã§ã§ã™ã€‚

`game.js`ã¯ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

```js
ï»¿var TITLE = 'ã‚·ãƒ³ãƒ—ãƒ«ãƒ­ãƒ¼ã‚°ãƒ©ã‚¤ã‚¯';

var TEXT_START = 'ã¯ã˜ã‚ã‚‹';

var SCREEN_X = 1600;
var SCREEN_Y = 800;

var LX = 25;
var LY = 25;
var PX = 32;
var PY = 32;

var B_FLOOR = 0;
var B_WALL = 1;
var B_DOWNSTAIR = 2;

var B_CAN_STAND = [];
B_CAN_STAND[B_FLOOR] = true;
B_CAN_STAND[B_WALL] = false;
B_CAN_STAND[B_DOWNSTAIR] = true;

var img = new Image();
img.src = 'Dungeon_B_Freem7.png';

var seed = Date.now().toString(10);

var startf = false;

var fields = null;
var player = null;

$(function(){
	var canvas = document.getElementById('game');
	var con = canvas.getContext('2d');

	var keyl = false;
	var keyu = false;
	var keyr = false;
	var keyd = false;

	var env = {
		diagonal: false
	};

	var c = $('body');
	c.on('keydown', function (e) {
		if (e.keyCode === 37) {
			keyl = true;
		}
		else if (e.keyCode === 38) {
			keyu = true;
		}
		else if (e.keyCode === 39) {
			keyr = true;
		}
		else if (e.keyCode === 40) {
			keyd = true;
		}
		else {
			keyl = false;
			keyu = false;
			keyr = false;
			keyd = false;
		}
	});
	c.on('keyup', function (e) {
		if (e.keyCode === 37) {
			keyl = false;
		}
		else if (e.keyCode === 38) {
			keyu = false;
		}
		else if (e.keyCode === 39) {
			keyr = false;
		}
		else if (e.keyCode === 40) {
			keyd = false;
		}
	});
	c.on('keydown', function (e) {
		if (!startf) {
			if (e.keyCode === 90) {
				startf = true;

				init();

				draw(con, env);
			}

			return;
		}

		if (e.keyCode === 16) {
			if (!env.diagonal) {
				env.diagonal = true;

				draw(con, env);
			}

			return;
		}

		if (e.keyCode >= 37 && e.keyCode <= 40) {
			var x = player.x;
			var y = player.y;
			if (e.shiftKey) {
				if (keyl && keyu) {
					if (x === 0 || y === 0) {
						return;
					}
					x--;
					y--;
				}
				else if (keyr && keyu) {
					if (x === LX - 1 || y === 0) {
						return;
					}
					x++;
					y--;
				}
				else if (keyl && keyd) {
					if (x === 0 || y === LY - 1) {
						return;
					}
					x--;
					y++;
				}
				else if (keyr && keyd) {
					if (x === LX - 1 || y === LY - 1) {
						return;
					}
					x++;
					y++;
				}
				else {
					return;
				}
			}
			else {
				if (e.keyCode === 37) {
					if (x === 0) {
						return;
					}
					x--;
				}
				else if (e.keyCode === 38) {
					if (y === 0) {
						return;
					}
					y--;
				}
				else if (e.keyCode === 39) {
					if (x === LX - 1) {
						return;
					}
					x++;
				}
				else if (e.keyCode === 40) {
					if (y === LY - 1) {
						return;
					}
					y++;
				}
			}

			if (x !== player.x || y !== player.y) {
				var block = fields[player.depth].blocks[x][y];
				if (B_CAN_STAND[block.base]) {
					player.x = x;
					player.y = y;
				}
				else {
					return;
				}
			}
			else {
				return;
			}
		}
		else if (e.keyCode === 32) {
			var block = fields[player.depth].blocks[player.x][player.y];
			if (block.base === B_DOWNSTAIR) {
				player.depth++;
				if (!fields[player.depth]) {
					fields[player.depth] = create_field(player.depth, [{
						x: player.x,
						y: player.y
					}], seed);
				}
			}
		}
		else {
			return;
		}

		draw(con, env);
	});
	c.on('keyup', function (e) {
		if (e.keyCode === 16) {
			if (env.diagonal) {
				env.diagonal = false;

				draw(con, env);
			}
		}
	});
	$(window).on('blur', function (e) {
		if (env.diagonal) {
			env.diagonal = false;

			draw(con, env);
		}
	});

	draw(con, env);
});

function init () {
	fields = [];
	fields[0] = create_field(0, [], seed);
	player = {
		depth: 0,
		x: 12,
		y: 17
	};
}

function create_field (depth, upstairs, base_seed) {
	var random = new Random(base_seed + ',' + depth.toString(10));

	var blocks = [];
	for (var i = 0; i < LX; i++) {
		blocks[i] = [];
		for (var j = 0; j < LY; j++) {
			if ((i === 0 || j === 0) || (i === LX -1 || j === LY - 1)) {
				blocks[i][j] = {
					base: B_WALL
				};
			}
			else {
				blocks[i][j] = {
					base: B_FLOOR
				};
			}
		}
	}

	if (depth === 0) {
		blocks[12][5] = {
			base: B_DOWNSTAIR
		};

		return {
			blocks: blocks
		};
	}

	var rs = [{
		x1: 1,
		x2: LX - 2,
		y1: 1,
		y2: LY - 2
	}];
	var ers = [];
	var dps = [1, 1, 1, 1, 1, 1, 0.5, 0.5, 0.5, 0.5];
	while (rs.length > 0 && dps.length > 0) {
		var r = rs.shift();
		var nrs = split_room(blocks, r, dps.shift(), random);
		for (var i = 0; i < nrs.length; i++) {
			rs.push(nrs[i]);
		}
		if (nrs.length === 0) {
			ers.push(r);
		}
	}
	while (rs.length > 0) {
		ers.push(rs.shift());
	}

	var nds = 1;
	while (nds > 0) {
		var x = random.num(LX - 2) + 1;
		var y = random.num(LY - 2) + 1;
		var f = true;
		for (var i = 0; i < upstairs.length; i++) {
			if (x === upstairs[i].x && y === upstairs[i].y) {
				f = false;
				break;
			}
		}
		if (f) {
			blocks[x][y].base = B_DOWNSTAIR;
			nds--;
		}
	}

	for (var i = 0; i < upstairs.length; i++) {
		if (blocks[upstairs[i].x][upstairs[i].y].base = B_WALL) {
			blocks[upstairs[i].x][upstairs[i].y].base = B_FLOOR;
		}
	}

	return {
		blocks: blocks
	};
}

function split_room (blocks, r, dp, random) {
	var ap = random.fraction();
	if (ap <= dp) {
		var dir = random.num(2);
		if (r.x2 - r.x1 > (r.y2 - r.y1) * 2) {
			dir = 0;
		}
		else if ((r.x2 - r.x1) * 2 < r.y2 - r.y1) {
			dir = 1;
		}

		if (dir === 0) {
			if (r.x2 - r.x1 <= 6) {
				return [];
			}

			var x = random.num(r.x2 - r.x1 - 6) + 3 + r.x1;
			if (blocks[x][r.y1 - 1].base !== B_WALL) {
				return [];
			}
			if (blocks[x][r.y2 + 1].base !== B_WALL) {
				return [];
			}
			var y = random.num(r.y2 - r.y1) + r.y1;
			for (var i = r.y1; i <= r.y2; i++) {
				if (i !== y) {
					blocks[x][i].base = B_WALL;
				}
			}

			var r1 = {
				x1: r.x1,
				x2: x - 1,
				y1: r.y1,
				y2: r.y2
			};
			var r2 = {
				x1: x + 1,
				x2: r.x2,
				y1: r.y1,
				y2: r.y2
			};
			var ord = random.num(2);
			if (ord === 0) {
				return [r1, r2];
			}
			else {
				return [r2, r1];
			}
		}
		else if (dir === 1) {
			if (r.y2 - r.y1 <= 6) {
				return [];
			}

			var y = random.num(r.y2 - r.y1 - 6) + 3 + r.y1;
			if (blocks[r.x1 - 1][y].base !== B_WALL) {
				return [];
			}
			if (blocks[r.x2 + 1][y].base !== B_WALL) {
				return [];
			}
			var x = random.num(r.x2 - r.x1) + r.x1;
			for (var i = r.x1; i <= r.x2; i++) {
				if (i !== x) {
					blocks[i][y].base = B_WALL;
				}
			}

			var r1 = {
				x1: r.x1,
				x2: r.x2,
				y1: r.y1,
				y2: y - 1
			};
			var r2 = {
				x1: r.x1,
				x2: r.x2,
				y1: y + 1,
				y2: r.y2
			};
			var ord = random.num(2);
			if (ord === 0) {
				return [r1, r2];
			}
			else {
				return [r2, r1];
			}
		}
	}
	return [];
}

function draw (con, env) {
	con.fillStyle = 'black';
	con.fillRect(0, 0, SCREEN_X, SCREEN_Y);

	if (!startf) {
		con.textBaseline = 'alphabetic';
		con.textAlign = 'center';
		con.fillStyle = 'white';

		con.font = "48px consolas";
		con.fillText(TITLE, SCREEN_X / 2, SCREEN_Y / 4);

		con.font = "32px consolas";
		con.fillText('> ' + TEXT_START, SCREEN_X / 2, SCREEN_Y / 4 * 3);

		return;
	}

	for (var i = 0; i < LX; i++) {
		for (var j = 0; j < LY; j++) {
			var block = fields[player.depth].blocks[i][j];
			if (block.base === B_FLOOR) {
				con.fillStyle = 'white';
				con.beginPath();
				con.arc((i + 0.5) * PX, (j + 0.5) * PY, 1, 0, Math.PI * 2);
				con.closePath();
				con.fill();
			}
			else if (block.base === B_WALL) {
				con.strokeStyle = 'white';
				con.strokeRect(i * PX, j * PY, PX, PY);
				con.beginPath();
				con.moveTo(i * PX, j * PY);
				con.lineTo((i + 1) * PX, (j + 1) * PY);
				con.moveTo((i + 1) * PX, j * PY);
				con.lineTo(i * PX, (j + 1) * PY);
				con.closePath();
				con.stroke();
			}
			else if (block.base === B_DOWNSTAIR) {
				con.drawImage(img, 4 * 32, 5 * 32, 32, 32, i * PX, j * PY, PX, PY);
			}
		}
	}

	con.textBaseline = 'middle';
	con.textAlign = 'center';
	con.fillStyle = 'red';
	con.font = '24px consolas';
	con.fillText('ğŸš¶\uFE0E', player.x * PX + (PX / 2), player.y * PY + (PY / 2));

	if (env.diagonal) {
		con.save();

		con.strokeStyle = 'white';
		con.translate(player.x * PX + (PX / 2), player.y * PY + (PY / 2));
		con.rotate(Math.PI / 4);
		con.beginPath();
		con.moveTo((PX / 2) + 4, -4);
		con.lineTo((PX / 2) + 4 + 8, -4);
		con.lineTo((PX / 2) + 4 + 8, -4 - 4);
		con.lineTo((PX / 2) + 4 + 8 + 8, 0);
		con.lineTo((PX / 2) + 4 + 8, 4 + 4);
		con.lineTo((PX / 2) + 4 + 8, 4);
		con.lineTo((PX / 2) + 4, 4);
		con.closePath();
		con.stroke();
		con.rotate(Math.PI / 4 * 2);
		con.beginPath();
		con.moveTo((PX / 2) + 4, -4);
		con.lineTo((PX / 2) + 4 + 8, -4);
		con.lineTo((PX / 2) + 4 + 8, -4 - 4);
		con.lineTo((PX / 2) + 4 + 8 + 8, 0);
		con.lineTo((PX / 2) + 4 + 8, 4 + 4);
		con.lineTo((PX / 2) + 4 + 8, 4);
		con.lineTo((PX / 2) + 4, 4);
		con.closePath();
		con.stroke();
		con.rotate(Math.PI / 4 * 2);
		con.beginPath();
		con.moveTo((PX / 2) + 4, -4);
		con.lineTo((PX / 2) + 4 + 8, -4);
		con.lineTo((PX / 2) + 4 + 8, -4 - 4);
		con.lineTo((PX / 2) + 4 + 8 + 8, 0);
		con.lineTo((PX / 2) + 4 + 8, 4 + 4);
		con.lineTo((PX / 2) + 4 + 8, 4);
		con.lineTo((PX / 2) + 4, 4);
		con.closePath();
		con.stroke();
		con.rotate(Math.PI / 4 * 2);
		con.beginPath();
		con.moveTo((PX / 2) + 4, -4);
		con.lineTo((PX / 2) + 4 + 8, -4);
		con.lineTo((PX / 2) + 4 + 8, -4 - 4);
		con.lineTo((PX / 2) + 4 + 8 + 8, 0);
		con.lineTo((PX / 2) + 4 + 8, 4 + 4);
		con.lineTo((PX / 2) + 4 + 8, 4);
		con.lineTo((PX / 2) + 4, 4);
		con.closePath();
		con.stroke();

		con.restore();
	}
}

function hash (seed) {
	var sha256 = new jsSHA('SHA-256', 'TEXT');
	sha256.update(seed);
	return sha256.getHash('HEX');
}

class Random {
	constructor (seed) {
		this.seed = seed;
		this.hash = hash(seed);
		this.pointer = 0;
	}

	byte () {
		if (this.pointer === 64) {
			this.hash = hash(this.hash);
			this.pointer = 0;
		}
		var value = this.hash.substring(this.pointer, this.pointer + 2);
		this.pointer += 2;
		return parseInt(value, 16);
	}

	num (max) {
		if (max <= 0) {
			throw new Error('max of random.num must be positive.');
		}
		else if (max <= 256) {
			return this.byte() % max;
		}
		else {
			throw new Error('not supported.');
		}
	}

	fraction () {
		return this.byte() / 256;
	}
}

function test_random_class_byte () {
	var a = [68, 9, 150, 66, 71, 184, 42, 152,
		84, 31, 148, 195, 79, 121, 253, 235,
		87, 142, 108, 87, 64, 95, 18, 186,
		184, 92, 200, 43, 179, 155, 117, 136,
		209, 241, 173, 107, 190, 11, 178, 50];
	var r = new Random('yurina');
	for (var i = 0; i < a.length; i++) {
		if (r.byte() !== a[i]) {
			throw new Error('test_random_class_byte');
		}
	}
}

function test_random_class_num () {
	var a = [0, 1, 0, 2, 1, 4, 0, 0, 3, 1, 5, 3, 1, 9, 13, 11];
	var r = new Random('yurina');
	for (var i = 0; i < a.length; i++) {
		if (r.num(i + 1) !== a[i]) {
			throw new Error('test_random_class_num');
		}
	}
}
```

æ¬¡å›ã¯ãƒ€ãƒ³ã‚¸ãƒ§ãƒ³ã®ã‚µã‚¤ã‚ºã‚’å¤§ããã—ã¦ã¿ã¾ã™ã€‚
