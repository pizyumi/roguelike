## ãƒ­ãƒ¼ã‚°ãƒ©ã‚¤ã‚¯ã‚²ãƒ¼ãƒ ã‚’ä½œã£ã¦ã¿ã‚‹ãã®9 ãƒãƒƒãƒ—ã¨è¦–ç•Œ

### éå»è¨˜äº‹ä¸€è¦§

* [ãã®1 ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢](https://qiita.com/pizyumi/items/3526fddd4f18a462e1ae)
* [ãã®2 ãƒ€ãƒ³ã‚¸ãƒ§ãƒ³ãƒ»ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ç”Ÿæˆã¨æç”»](https://qiita.com/pizyumi/items/2562a159f497a608615b)
* [ãã®3 ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ç§»å‹•](https://qiita.com/pizyumi/items/07447c9a1a52b0d9a228)
* [ãã®4 ãƒ€ãƒ³ã‚¸ãƒ§ãƒ³ã®ãƒ©ãƒ³ãƒ€ãƒ ç”Ÿæˆ]()
* [ãã®5 ãƒ€ãƒ³ã‚¸ãƒ§ãƒ³ã®ã‚µã‚¤ã‚º]()

ç¾åœ¨ã®ã‚³ãƒ¼ãƒ‰ã«ã¤ã„ã¦ã¯å‰å›ã®è¨˜äº‹ã®æœ€å¾Œã®é …ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

### ãƒãƒƒãƒ—ã¨è¦–ç•Œ



ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®è¦–ç•Œã¯éƒ¨å±‹ã«ã„ã‚‹æ™‚ã¯éƒ¨å±‹å…¨ä½“ï¼‹å‘¨å›²1ãƒã‚¹ã¨ã—ã€éƒ¨å±‹ã«ã„ãªã„æ™‚ã¯å‘¨å›²1ãƒã‚¹ã®ã¿ã¨ã™ã‚‹ã“ã¨ã«ã—ã¾ã—ã‚‡ã†ã€‚

ãã—ã¦ã€è¦–ç•Œã«å¿œã˜ã¦ã‚²ãƒ¼ãƒ ç”»é¢ã®ãƒ•ãƒ­ã‚¢ã‚„ãƒãƒƒãƒ—ã®æç”»ã‚’å¤‰ãˆã‚‹ã“ã¨ã«ã—ã¾ã—ã‚‡ã†ã€‚

ãƒ•ãƒ­ã‚¢ã¯ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®è¦–ç•Œå†…ã®ã¿ã‚’ç™½è‰²ã§æç”»ã™ã‚‹ã“ã¨ã«ã—ã€è¦–ç•Œå¤–ï¼ˆã§ä»¥å‰è¦–ç•Œå†…ã«å…¥ã£ãŸã“ã¨ãŒã‚ã‚‹éƒ¨åˆ†ï¼‰ã¯ç°è‰²ã§æç”»ã™ã‚‹ã“ã¨ã«ã—ã¾ã™ã€‚

### ãƒãƒƒãƒ—ã®ç”Ÿæˆ

æœ€åˆã«ã€ãƒãƒƒãƒ—ã‚„è¦–ç•Œã®å‡¦ç†ã‚’è¡Œã†ãŸã‚ã®æº–å‚™ã‚’ã—ã¾ã—ã‚‡ã†ã€‚

ãƒãƒƒãƒ—ã¯ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®çŠ¶æ…‹ã®ä¸€ç¨®ãªã®ã§ã€`Player`ã‚¯ãƒ©ã‚¹ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã¨ã—ã¦æ ¼ç´ã™ã‚‹ã“ã¨ã«ã—ã¾ã—ã‚‡ã†ã€‚

`Player`ã‚¯ãƒ©ã‚¹ã«`maps`ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’è¿½åŠ ã—ã¾ã™ã€‚

ã“ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«å…¨ã¦ã®ãƒ•ãƒ­ã‚¢ã®ãƒãƒƒãƒ—ã‚’æ ¼ç´ã™ã‚‹ã“ã¨ã«ã—ã¾ã™ã€‚

```js
class Player {
	constructor () {
ï¼ˆçœç•¥ï¼‰
		this.items = [];
		this.maps = [];
	}
ï¼ˆçœç•¥ï¼‰
}
```

ã¾ãŸã€ãƒãƒƒãƒ—ã‚„è¦–ç•Œã®å‡¦ç†ã‚’è¡Œã†ã«ã¯ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒç¾åœ¨ã„ã‚‹éƒ¨å±‹ã‚’ç›£è¦–ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ãƒ•ãƒ­ã‚¢ã®éƒ¨å±‹ã®æƒ…å ±ã¯ãƒ•ãƒ­ã‚¢ã®ä½œæˆæ™‚ã«æ¨ã¦ã¦ã—ã¾ã£ã¦ã„ã¾ã—ãŸãŒã€ã“ã‚Œã‚’ãƒ•ãƒ­ã‚¢ã‚’è¡¨ã™ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®`rooms`ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«è¿½åŠ ã—ã€å¾Œã‹ã‚‰å‚ç…§ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

`create_field`é–¢æ•°ã‚’ä¸‹ã®ã‚ˆã†ã«å¤‰æ›´ã—ã¾ã™ã€‚

```js
function create_field (depth, upstairs, base_seed) {
ï¼ˆçœç•¥ï¼‰
	if (depth === 0) {
ï¼ˆçœç•¥ï¼‰
		return {
			nx: nx,
			ny: ny,
			blocks: blocks,
			rooms: [{
				x1: 1,
				x2: nx - 2,
				y1: 1,
				y2: ny - 2
			}],
			npcs: []
		};
	}
ï¼ˆçœç•¥ï¼‰
	return {
		nx: nx,
		ny: ny,
		blocks: blocks,
		rooms: ers,
		npcs: npcs
	};
}
```

ã¾ãŸã€ä¸‹ã®ã‚ˆã†ãª3ã¤ã®ä½ç½®ã«é–¢ã™ã‚‹åˆ¤å®šé–¢æ•°ã‚’è¿½åŠ ã—ã¾ã™ã€‚

* `within_room`é–¢æ•°ãƒ»ãƒ»ãƒ»ã‚ã‚‹ä½ç½®ãŒã‚ã‚‹éƒ¨å±‹ã®ä¸­ãªã®ã‹åˆ¤å®šã™ã‚‹ã€‚
* `within_room_surrounding`é–¢æ•°ãƒ»ãƒ»ãƒ»ã‚ã‚‹ä½ç½®ãŒã‚ã‚‹éƒ¨å±‹ï¼‹å‘¨å›²1ãƒã‚¹ã®ä¸­ãªã®ã‹åˆ¤å®šã™ã‚‹ã€‚
* `within_player_surrounding`é–¢æ•°ãƒ»ãƒ»ãƒ»ã‚ã‚‹ä½ç½®ãŒãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å‘¨å›²1ãƒã‚¹ã®ä¸­ãªã®ã‹åˆ¤å®šã™ã‚‹ã€‚

```js
function within_room (x, y, room) {
	return x >= room.x1 && x <= room.x2 && y >= room.y1 && y <= room.y2;
}

function within_room_surrounding (x, y, room) {
	return x >= room.x1 - 1 && x <= room.x2 + 1 && y >= room.y1 - 1 && y <= room.y2 + 1;
}

function within_player_surrounding (x, y) {
	return x >= player.x - 1 && x <= player.x + 1 && y >= player.y - 1 && y <= player.y + 1;
}
```

æ¬¡ã«ã€ã‚ã‚‹ãƒ•ãƒ­ã‚¢ã®ãƒãƒƒãƒ—ã‚’åˆæœŸåŒ–ã™ã‚‹`init_map`é–¢æ•°ã‚’è¿½åŠ ã—ã¾ã™ã€‚

ç¬¬1å¼•æ•°ã¨ã—ã¦ãƒãƒƒãƒ—ã‚’åˆæœŸåŒ–ã™ã‚‹ãƒ•ãƒ­ã‚¢ã‚’å—ã‘å–ã‚Šã¾ã™ã€‚

ãƒ•ãƒ­ã‚¢ã®ã‚µã‚¤ã‚ºã«å¿œã˜ã¦ãƒãƒƒãƒ—ã‚’åˆæœŸåŒ–ã—ã€ãƒãƒƒãƒ—ã‚’è¡¨ã™ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è¿”ã—ã¾ã™ã€‚

ãƒãƒƒãƒ—ã‚’è¡¨ã™ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯ä¸‹ã®ã‚ˆã†ãªãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’æœ‰ã—ã¾ã™ã€‚

* `nx`ãƒ»ãƒ»ãƒ»ãƒãƒƒãƒ—ã®æ¨ªæ–¹å‘ã®ã‚µã‚¤ã‚ºï¼ˆãƒãƒƒãƒ—ãŒè¡¨ã™ãƒ•ãƒ­ã‚¢ã®æ¨ªæ–¹å‘ã®ã‚µã‚¤ã‚ºã¨åŒã˜ï¼‰
* `ny`ãƒ»ãƒ»ãƒ»ãƒãƒƒãƒ—ã®ç¸¦æ–¹å‘ã®ã‚µã‚¤ã‚ºï¼ˆãƒãƒƒãƒ—ãŒè¡¨ã™ãƒ•ãƒ­ã‚¢ã®ç¸¦æ–¹å‘ã®ã‚µã‚¤ã‚ºã¨åŒã˜ï¼‰
* `blocks`ãƒ»ãƒ»ãƒ»ãƒãƒƒãƒ—ã®ãƒã‚¹ï¼ˆãƒãƒƒãƒ—ã®ãã‚Œãã‚Œã®ãƒã‚¹ã¯ãƒãƒƒãƒ—ãŒè¡¨ã™ãƒ•ãƒ­ã‚¢ã®ãƒã‚¹ã«å¯¾å¿œã™ã‚‹ï¼‰
* `room`ãƒ»ãƒ»ãƒ»ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒç¾åœ¨ã„ã‚‹éƒ¨å±‹

ãƒãƒƒãƒ—ã¯æœ€åˆå…¨ã¦ã®ãƒã‚¹ãŒä½•ã®ãƒã‚¹ãªã®ã‹ä¸æ˜ãªçŠ¶æ…‹ãªã®ã§ã€ãƒãƒƒãƒ—ã®å…¨ã¦ã®ãƒã‚¹ã®åˆæœŸå€¤ã¯`M_UNKNOWN`ã¨ã—ã¾ã™ã€‚

`M_UNKNOWN`ã®å€¤ã¯`65535`ã¨ã—ã¾ã—ãŸã€‚ã“ã®å€¤ã¯ãƒã‚¹ã®ç¨®é¡ã®å€¤ã¨è¢«ã£ã¦ã¯ã„ã‘ã¾ã›ã‚“ã€‚

```js
var M_UNKNOWN = 65535;
```

```js
function init_map (field) {
	var nx = field.nx;
	var ny = field.ny;
	var blocks = [];
	for (var i = 0; i < nx; i++) {
		blocks[i] = [];
		for (var j = 0; j < ny; j++) {
			blocks[i][j] = M_UNKNOWN;
		}
	}
	return {
		nx: nx,
		ny: ny,
		blocks: blocks,
		room: null
	};
}
```

ãã®æ¬¡ã«ã€ãƒ•ãƒ­ã‚¢ã®ãƒãƒƒãƒ—ã‚’æ›´æ–°ã™ã‚‹`update_map`é–¢æ•°ã‚’è¿½åŠ ã—ã¾ã™ã€‚

ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒéƒ¨å±‹ã®ä¸­ã«ã„ã‚‹å ´åˆã«ã¯ãã®éƒ¨å±‹å…¨ä½“ï¼‹å‘¨å›²1ãƒã‚¹ã®ãƒãƒƒãƒ—ã‚’æ›´æ–°ã—ã€éƒ¨å±‹ã®ä¸­ã«ã„ãªã„å ´åˆã«ã¯ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å‘¨å›²1ãƒã‚¹ã®ãƒãƒƒãƒ—ã‚’æ›´æ–°ã—ã¾ã™ã€‚

```
function update_map (map, field, x, y) {
	for (var i = 0; i < field.rooms.length; i++) {
		var room = field.rooms[i];
		if (within_room(x, y, room)) {
			for (var j = room.x1 - 1; j <= room.x2 + 1; j++) {
				for (var k = room.y1 - 1; k <= room.y2 + 1; k++) {
					map.blocks[j][k] = field.blocks[j][k].base;
				}
			}
			map.room = room;
			return;
		}
	}
	map.blocks[x][y] = field.blocks[x][y].base;
	map.blocks[x - 1][y] = field.blocks[x - 1][y].base;
	map.blocks[x + 1][y] = field.blocks[x + 1][y].base;
	map.blocks[x][y - 1] = field.blocks[x][y - 1].base;
	map.blocks[x][y + 1] = field.blocks[x][y + 1].base;
	map.blocks[x - 1][y - 1] = field.blocks[x - 1][y - 1].base;
	map.blocks[x + 1][y - 1] = field.blocks[x + 1][y - 1].base;
	map.blocks[x - 1][y + 1] = field.blocks[x - 1][y + 1].base;
	map.blocks[x + 1][y + 1] = field.blocks[x + 1][y + 1].base;
	map.room = null;
}
```

ãƒãƒƒãƒ—ã¯ãƒ•ãƒ­ã‚¢ã®åˆæœŸåŒ–æ™‚ã«åˆæœŸåŒ–ã•ã‚Œãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ã€‚

ã¾ãŸã€ãƒ•ãƒ­ã‚¢ã®åˆæœŸåŒ–æ™‚ã¨ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒç§»å‹•ã—ãŸæ™‚ã«æ›´æ–°ã•ã‚Œãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ã€‚

`init`é–¢æ•°ã‚’ä¸‹ã®ã‚ˆã†ã«å¤‰æ›´ã—ã¾ã™ã€‚

ãƒ•ãƒ­ã‚¢ã®ä½œæˆå¾Œ`init_map`é–¢æ•°ã¨`update_map`é–¢æ•°ã‚’å‘¼ã³å‡ºã—ã¦ãƒãƒƒãƒ—ã®åˆæœŸåŒ–ã¨æ›´æ–°ã‚’è¡Œã„ã¾ã™ã€‚

```js
function init () {
ï¼ˆçœç•¥ï¼‰
	fields = [];
	fields[0] = create_field(0, [], seed);
	player = new Player();
	player.maps[0] = init_map(fields[0]);
	update_map(player.maps[0], fields[0], player.x, player.y);
	messages = [{
		text: MSG_INIT,
		type: 'special'
	}];
}
```

2ã¤ç›®ã®`keydown`ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ã‚’ä¸‹ã®ã‚ˆã†ã«å¤‰æ›´ã—ã¾ã™ã€‚

ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒç§»å‹•ã—ãŸæ™‚ã«`update_map`é–¢æ•°ã‚’å‘¼ã³å‡ºã—ã¦ãƒãƒƒãƒ—ã®æ›´æ–°ã‚’è¡Œã„ã¾ã™ã€‚

ã¾ãŸã€ä¸‹ã‚Šéšæ®µã§ä¸‹ã®éšã«é™ã‚ŠãŸæ™‚ã«`init_map`é–¢æ•°ï¼ˆã¾ã ãƒãƒƒãƒ—ãŒä½œæˆã•ã‚Œã¦ã„ãªã„å ´åˆï¼‰ã¨`update_map`é–¢æ•°ã‚’å‘¼ã³å‡ºã—ã¦ãƒãƒƒãƒ—ã®åˆæœŸåŒ–ã¨æ›´æ–°ã‚’è¡Œã„ã¾ã™ã€‚

```js
	c.on('keydown', function (e) {
ï¼ˆçœç•¥ï¼‰
		if (e.keyCode >= 37 && e.keyCode <= 40) {
ï¼ˆçœç•¥ï¼‰
			if (x !== player.x || y !== player.y) {
ï¼ˆçœç•¥ï¼‰
				if (c) {
ï¼ˆçœç•¥ï¼‰
				}
				else {
					var block = fields[player.depth].blocks[x][y];
					if (B_CAN_STAND[block.base]) {
						player.x = x;
						player.y = y;
						update_map(player.maps[player.depth], fields[player.depth], player.x, player.y);
					}
					else {
ï¼ˆçœç•¥ï¼‰
					}
				}
			}
			else {
				return;
			}
		}
		else if (e.keyCode === 32) {
			var block = fields[player.depth].blocks[player.x][player.y];
			if (block.items && block.items.length > 0) {
ï¼ˆçœç•¥ï¼‰
			}
			else if (block.base === B_DOWNSTAIR) {
				player.depth++;
				if (!fields[player.depth]) {
					fields[player.depth] = create_field(player.depth, [{
						x: player.x,
						y: player.y
					}], seed);
				}
				if (!player.maps[player.depth]) {
					player.maps[player.depth] = init_map(fields[player.depth]);
				}
				update_map(player.maps[player.depth], fields[player.depth], player.x, player.y);
				add_message({
					text: MSG_DOWNSTAIR,
					type: 'normal'
				});
			}
			else {
				return;
			}
		}
		else if (e.keyCode === 88) {
ï¼ˆçœç•¥ï¼‰
		}
		else {
			return;
		}
ï¼ˆçœç•¥ï¼‰
	});
```

### ãƒ•ãƒ­ã‚¢ã¨ãƒãƒƒãƒ—ã®æç”»

ã‚²ãƒ¼ãƒ ç”»é¢ã®å³ä¸Šç«¯ã«ãƒãƒƒãƒ—ã‚’æç”»ã™ã‚‹ã“ã¨ã«ã—ã¾ã™ã€‚

ã¾ãŸã€ãƒ•ãƒ­ã‚¢ã®æç”»ã«ãŠã„ã¦ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®è¦–ç•Œã‚’åæ˜ ã™ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

ã‚²ãƒ¼ãƒ ç”»é¢ã«ãŠã‘ã‚‹ãƒãƒƒãƒ—ã®ã‚µã‚¤ã‚ºã‚’å®šç¾©ã—ã¾ã™ã€‚ãƒãƒƒãƒ—ã®ã‚µã‚¤ã‚ºã¯256ãƒ”ã‚¯ã‚»ãƒ«x256ãƒ”ã‚¯ã‚»ãƒ«ã¨ã—ã¾ã™ã€‚

```js
var MAP_WIDTH = 256;
var MAP_HEIGHT = 256;
```

`draw`é–¢æ•°ã‚’ä¸‹ã®ã‚ˆã†ã«å¤‰æ›´ã—ã¾ã™ã€‚

ãƒ•ãƒ­ã‚¢ã®æç”»ã«ãŠã„ã¦ã¯ãƒãƒƒãƒ—ã§ä¸æ˜ã¨ãªã£ã¦ã„ã‚‹éƒ¨åˆ†ã¯æç”»ã—ã¾ã›ã‚“ã€‚

ã¾ãŸã€è¦–ç•Œå†…ã¯ç™½è‰²ã§æç”»ã—ã€è¦–ç•Œå¤–ã¯ç°è‰²ã§æç”»ã—ã¾ã™ã€‚

ã¾ãŸã€è¦–ç•Œå¤–ã®æ•µã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®æç”»ã—ã¾ã›ã‚“ã€‚

ãã—ã¦ã€ã‚²ãƒ¼ãƒ ç”»é¢ã®å³ä¸Šç«¯ã«ãƒãƒƒãƒ—ã‚’æç”»ã—ã¾ã™ã€‚

ãƒãƒƒãƒ—ã§ä¸æ˜ã¨ãªã£ã¦ã„ã‚‹éƒ¨åˆ†ã¯ç°è‰²ã§æç”»ã—ã¾ã™ã€‚

å£ã¯é»’è‰²ã§æç”»ã—ã€ä¸‹ã‚Šéšæ®µã¯é»„ç·‘è‰²ã§æç”»ã—ã€åºŠã¯é’è‰²ã§æç”»ã—ã¾ã™ã€‚ãŸã ã—ã€è¦–ç•Œå†…ã®åºŠã¯ã‚ˆã‚Šè–„ã„é’è‰²ã§æç”»ã—ã¾ã™ã€‚

ã¾ãŸã€ã‚¢ã‚¤ãƒ†ãƒ ã¯é»„è‰²ã§æç”»ã—ã€æ•µã¯èµ¤è‰²ã§æç”»ã—ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯æ¡ƒè‰²ã§æç”»ã—ã¾ã™ã€‚

```js
function draw (con, env) {
ï¼ˆçœç•¥ï¼‰
	var npcs = fields[player.depth].npcs;
	var room = player.maps[player.depth].room;

	for (var i = 0; i < SX; i++) {
		for (var j = 0; j < SY; j++) {
			var block = fields[player.depth].blocks[ox + i][oy + j];
			var mblock = player.maps[player.depth].blocks[ox + i][oy + j];
			if (mblock !== M_UNKNOWN) {
				if ((room !== null && within_room_surrounding(ox + i, oy + j, room)) || (room === null && within_player_surrounding(ox + i, oy + j))) {
					con.fillStyle = 'white';
					con.strokeStyle = 'white';
				}
				else {
					con.fillStyle = 'gray';
					con.strokeStyle = 'gray';
				}

				if (block.base === B_FLOOR) {
					con.beginPath();
					con.arc((i + 0.5) * PX, (j + 0.5) * PY, 1, 0, Math.PI * 2);
					con.closePath();
					con.fill();
				}
				else if (block.base === B_WALL) {
					con.strokeRect(i * PX, j * PY, PX, PY);
					con.beginPath();
					con.moveTo(i * PX, j * PY);
					con.lineTo((i + 1) * PX, (j + 1) * PY);
					con.moveTo((i + 1) * PX, j * PY);
					con.lineTo(i * PX, (j + 1) * PY);
					con.closePath();
					con.stroke();
				}
				else if (block.base === B_DOWNSTAIR) {
					con.drawImage(img, 4 * 32, 5 * 32, 32, 32, i * PX, j * PY, PX, PY);
				}

				if (block.items) {
					for (var k = 0; k < block.items.length; k++) {
						if (block.items[k].type === I_APPLE) {
							con.drawImage(img2, 0 * 32, 0 * 32, 32, 32, i * PX, j * PY, PX, PY);
						}
						else if (block.items[k].cat === I_CAT_POTION) {
							con.drawImage(img2, 7 * 32, 4 * 32, 32, 32, i * PX, j * PY, PX, PY);
						}
					}
				}
			}
		}
	}

	con.textBaseline = 'middle';
	con.textAlign = 'center';
	for (var i = 0; i < npcs.length; i++) {
		if (npcs[i].x >= ox && npcs[i].x < ox + SX && npcs[i].y >= oy && npcs[i].y < oy + SY) {
			if ((room !== null && within_room_surrounding(npcs[i].x, npcs[i].y, room)) || (room === null && within_player_surrounding(npcs[i].x, npcs[i].y))) {
				if (npcs[i].type === E_RAT) {
					con.fillStyle = 'yellow';
					con.font = '24px consolas';
					con.fillText('ğŸ€\uFE0E', (npcs[i].x - ox) * PX + (PX / 2), (npcs[i].y - oy) * PY + (PY / 2));
				}
			}
		}
	}
ï¼ˆçœç•¥ï¼‰
	con.save();
	var nx = player.maps[player.depth].nx;
	var ny = player.maps[player.depth].nx;
	var px = Math.floor(MAP_WIDTH / nx);
	var py = Math.floor(MAP_HEIGHT / ny);
	con.translate(SCREEN_X - nx * px, 0);
	for (var i = 0; i < nx; i++) {
		for (var j = 0; j < ny; j++) {
			var block = fields[player.depth].blocks[i][j];
			var mblock = player.maps[player.depth].blocks[i][j];
			if (mblock === M_UNKNOWN) {
				con.fillStyle = 'gray';
			}
			else if (mblock === B_FLOOR) {
				if (block.items && block.items.length > 0) {
					con.fillStyle = 'yellow';
				}
				else if (room !== null && within_room_surrounding(i, j, room)) {
					con.fillStyle = 'dodgerblue';
				}
				else if (room === null && within_player_surrounding(i, j)) {
					con.fillStyle = 'dodgerblue';
				}
				else {
					con.fillStyle = 'royalblue';
				}
			}
			else if (mblock === B_WALL) {
				con.fillStyle = 'black';
			}
			else if (mblock === B_DOWNSTAIR) {
				con.fillStyle = 'yellowgreen';
			}
			con.fillRect(i * px, j * py, px, py);
		}
	}
	for (var i = 0; i < npcs.length; i++) {
		if ((room !== null && within_room_surrounding(npcs[i].x, npcs[i].y, room)) || (room === null && within_player_surrounding(npcs[i].x, npcs[i].y))) {
			con.fillStyle = 'red';
			con.fillRect(npcs[i].x * px, npcs[i].y * py, px, py);
		}
	}
	con.fillStyle = 'pink';
	con.fillRect(player.x * px, player.y * py, px, py);
	con.restore();
}
```









### ä»Šå›ã¯ã“ã“ã¾ã§

ä»Šå›ã¯ã“ã“ã¾ã§ã§ã™ã€‚

`game.js`ã¯ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

```js
ï»¿```

æ¬¡å›ã¯ãƒãƒƒãƒ—ã®æç”»ã«ã¤ã„ã¦è€ƒãˆãŸã„ã¨æ€ã„ã¾ã™ã€‚
